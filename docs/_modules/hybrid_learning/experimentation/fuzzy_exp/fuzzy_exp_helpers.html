<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers &mdash; hybrid_learning  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/autoclasstoc.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> hybrid_learning
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../userguide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apiref/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">How to contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">hybrid_learning</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright (c) 2022 Continental Automotive GmbH</span>
<span class="sd">&quot;&quot;&quot;Helper functions for experiment evaluating fuzzy logic rules.</span>
<span class="sd">This includes definition of a standard logic to use.</span>
<span class="sd">Most functions are based on receiving an experiment config mapping,</span>
<span class="sd">as is created by Sacred experiments (see respective Sacred experiment script for config format).</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Hashable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.datasets</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">trafos</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.datasets.custom</span> <span class="kn">import</span> <span class="n">coco</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.datasets.custom.coco.keypoints_processing</span> <span class="kn">import</span> <span class="n">person_has_rel_size</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.concepts.models</span> <span class="kn">import</span> <span class="n">ConceptDetectionModel2D</span> <span class="k">as</span> <span class="n">ConceptModel</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.concepts</span> <span class="kn">import</span> <span class="n">train_eval</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.concepts.models</span> <span class="kn">import</span> <span class="n">model_extension</span><span class="p">,</span> <span class="n">ConceptEmbedding</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.dataloader</span> <span class="kn">import</span> <span class="n">default_collate</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.experimentation.model_registry</span> <span class="kn">import</span> <span class="n">get_model</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.experimentation</span> <span class="kn">import</span> <span class="n">ca_exp_eval</span>
<span class="kn">from</span> <span class="nn">hybrid_learning</span> <span class="kn">import</span> <span class="n">fuzzy_logic</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.fuzzy_logic.predicates</span> <span class="kn">import</span> <span class="n">custom_ops</span>

<span class="c1"># Only for type checking</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">PIL.Image</span>
<span class="kn">from</span> <span class="nn">hybrid_learning</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.datasets</span> <span class="kn">import</span> <span class="n">caching</span>


<span class="c1"># ====================</span>
<span class="c1"># CUSTOM LOGIC</span>
<span class="c1"># ====================</span>

<span class="k">def</span> <span class="nf">_filter_predicate_setts</span><span class="p">(</span><span class="n">logic_op</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">MergeBuilder</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span>
                            <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Filter ``predicate_setts`` to only those entries relevant for ``logic_op``.</span>
<span class="sd">    Allowed keys: ``SYMB`` attribute value or class ``__name__`` property.</span>
<span class="sd">    The returned dict entries are sorted ascending by precedence of the respective settings dict.</span>
<span class="sd">    Precedence: Settings for more specific classes and the ``SYMB`` value are preferred.&quot;&quot;&quot;</span>
    <span class="n">symbs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logic_op</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">):</span>
        <span class="n">mro_leaf</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">logic_op</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logic_op</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">MergeBuilder</span><span class="p">):</span>
        <span class="n">mro_leaf</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="n">logic_op</span><span class="o">.</span><span class="n">merge_class</span>
        <span class="n">symbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logic_op</span><span class="o">.</span><span class="n">SYMB</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mro_leaf</span> <span class="o">=</span> <span class="n">logic_op</span>
    <span class="n">logic_op_mro</span> <span class="o">=</span> <span class="p">[</span><span class="n">lop</span> <span class="k">for</span> <span class="n">lop</span> <span class="ow">in</span> <span class="n">mro_leaf</span><span class="o">.</span><span class="vm">__mro__</span> <span class="k">if</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="ow">in</span> <span class="n">lop</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">]</span>
    <span class="c1"># Any symbols of this logic_op class and its base classes</span>
    <span class="c1"># that may be used as key in predicate_setts</span>
    <span class="n">symbs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">bcls</span> <span class="ow">in</span> <span class="n">logic_op_mro</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">bcls</span><span class="p">,</span> <span class="s1">&#39;SYMB&#39;</span><span class="p">,</span> <span class="n">bcls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">bcls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]]</span>
    <span class="c1"># Settings for this logic operation</span>
    <span class="c1"># Precedence: sorted descending by class specificity, [symbol, class name]</span>
    <span class="n">additional_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">predicate_setts</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                                                   <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">symbs</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">predicate_setts</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">additional_setts</span>


<div class="viewcode-block" id="get_logic"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_logic.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_logic">[docs]</a><span class="k">def</span> <span class="nf">get_logic</span><span class="p">(</span><span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">warn_about_unused_setts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Logic</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get a fuzzy logic from key and settings.&quot;&quot;&quot;</span>
    <span class="n">logic</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Logic</span> <span class="o">=</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">logic_by_name</span><span class="p">(</span><span class="n">fuzzy_logic_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_predicate_setts</span><span class="p">(</span><span class="n">logic_op</span><span class="p">,</span> <span class="n">pred_setts</span><span class="o">=</span><span class="n">predicate_setts</span><span class="p">):</span>
        <span class="n">pred_setts</span> <span class="o">=</span> <span class="n">pred_setts</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">additional_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">setts_dict</span> <span class="ow">in</span> <span class="n">_filter_predicate_setts</span><span class="p">(</span><span class="n">logic_op</span><span class="p">,</span> <span class="n">pred_setts</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">setts_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">additional_setts</span><span class="p">:</span>
            <span class="n">logic_op</span> <span class="o">=</span> <span class="n">logic_op</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="o">**</span><span class="n">additional_setts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logic_op</span>

    <span class="k">def</span> <span class="nf">add_op</span><span class="p">(</span><span class="n">logic_op</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pred_setts</span><span class="o">=</span><span class="n">predicate_setts</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Logic</span> <span class="o">=</span> <span class="n">logic</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">apply_predicate_setts</span><span class="p">(</span><span class="n">logic_op</span><span class="p">,</span> <span class="n">pred_setts</span><span class="p">))</span>

    <span class="c1"># Common settings</span>
    <span class="n">channel_dim</span><span class="p">,</span> <span class="n">mask_dims</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Standard ones</span>
    <span class="n">logic</span><span class="o">.</span><span class="n">operators</span> <span class="o">=</span> <span class="p">[</span><span class="n">apply_predicate_setts</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">logic</span><span class="o">.</span><span class="n">operators</span><span class="p">]</span>
    <span class="c1"># CoveredBy</span>
    <span class="n">add_op</span><span class="p">(</span><span class="n">custom_ops</span><span class="o">.</span><span class="n">CoveredBy</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">logical_and</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span> <span class="n">logical_or</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;OR&#39;</span><span class="p">),</span> <span class="n">mask_dims</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># IoUWith</span>
    <span class="n">add_op</span><span class="p">(</span><span class="n">custom_ops</span><span class="o">.</span><span class="n">IoUWith</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">logical_and</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span> <span class="n">logical_or</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;OR&#39;</span><span class="p">),</span> <span class="n">mask_dims</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># BestIoUWith</span>
    <span class="n">add_op</span><span class="p">(</span><span class="n">custom_ops</span><span class="o">.</span><span class="n">BestIoUWith</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">logical_and</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">),</span> <span class="n">logical_or</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;OR&#39;</span><span class="p">),</span> <span class="n">mask_dims</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># IsPartOfA</span>
    <span class="n">add_op</span><span class="p">(</span><span class="n">custom_ops</span><span class="o">.</span><span class="n">IsPartOfA</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">logical_and</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;AND&#39;</span><span class="p">)),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># AllNeighbors</span>
    <span class="n">add_op</span><span class="p">(</span><span class="n">custom_ops</span><span class="o">.</span><span class="n">AllNeighbors</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># AllNeighborsGT</span>
    <span class="n">add_op</span><span class="p">(</span><span class="n">custom_ops</span><span class="o">.</span><span class="n">AllNeighbors</span><span class="o">.</span><span class="n">with_</span><span class="p">()</span><span class="o">.</span><span class="n">symb_</span><span class="p">(</span><span class="s1">&#39;GTAllNeighbors&#39;</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Arithmetic comparisons</span>
    <span class="n">logic</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">apply_predicate_setts</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">predicates</span><span class="o">.</span><span class="n">arithmetic</span><span class="o">.</span><span class="n">ARITHMETIC_OP_PRECEDENCE</span><span class="p">])</span>
    <span class="c1"># Quantifiers</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">ALL</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">)</span><span class="o">.</span><span class="n">symb_</span><span class="p">(</span><span class="s1">&#39;AllPixels&#39;</span><span class="p">),</span>
               <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">ALL</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">channel_dim</span><span class="p">)</span><span class="o">.</span><span class="n">symb_</span><span class="p">(</span><span class="s1">&#39;AllMasks&#39;</span><span class="p">),</span>
               <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">ANY</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">)</span><span class="o">.</span><span class="n">symb_</span><span class="p">(</span><span class="s1">&#39;AnyPixel&#39;</span><span class="p">),</span>
               <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">ANY</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">channel_dim</span><span class="p">)</span><span class="o">.</span><span class="n">symb_</span><span class="p">(</span><span class="s1">&#39;AnyMask&#39;</span><span class="p">),</span>
               <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">ANY</span><span class="o">.</span><span class="n">with_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">channel_dim</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">logic</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s1">&#39;OR&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">symb_</span><span class="p">(</span><span class="s1">&#39;MasksOR&#39;</span><span class="p">),</span>
               <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">WHERE</span><span class="p">,</span>
               <span class="p">]:</span>
        <span class="n">add_op</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="c1"># Some warning about unused predicate_setts entries</span>
    <span class="k">if</span> <span class="n">warn_about_unused_setts</span><span class="p">:</span>
        <span class="n">unused_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">setts</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">setts</span> <span class="ow">in</span> <span class="n">predicate_setts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">symb</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">logic</span>
                                                     <span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="n">_filter_predicate_setts</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">)]}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unused_keys</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Found unused predicate_setts (maybe typo in key?): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unused_keys</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logic</span></div>


<div class="viewcode-block" id="get_logic_from_conf"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_logic_from_conf.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_logic_from_conf">[docs]</a><span class="k">def</span> <span class="nf">get_logic_from_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">warn_about_unused_setts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Logic</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prepare a logic object with the correct predicates from given sacred experiment ``conf``.&quot;&quot;&quot;</span>
    <span class="n">predicate_setts</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicate_setts&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="s1">&#39;predicate_setts&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conf</span> <span class="ow">and</span> <span class="s1">&#39;ispartofa_setts&#39;</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span>
        <span class="n">predicate_setts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;IsPartofA&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;ispartofa_setts&#39;</span><span class="p">]})</span>
    <span class="k">for</span> <span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;ispartofa&#39;</span><span class="p">,</span> <span class="s1">&#39;IsPartOfA&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;allneighbors&#39;</span><span class="p">,</span> <span class="s1">&#39;AllNeighbors&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;allneighborsgt&#39;</span><span class="p">,</span> <span class="s1">&#39;GTAllNeighbors&#39;</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">predicate_setts</span><span class="p">:</span>
            <span class="n">predicate_setts</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicate_setts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_logic</span><span class="p">(</span><span class="n">fuzzy_logic_key</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;fuzzy_logic_key&#39;</span><span class="p">],</span> <span class="n">predicate_setts</span><span class="o">=</span><span class="n">predicate_setts</span><span class="p">,</span> <span class="n">warn_about_unused_setts</span><span class="o">=</span><span class="n">warn_about_unused_setts</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_formula"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_formula.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_formula">[docs]</a><span class="k">def</span> <span class="nf">get_formula</span><span class="p">(</span><span class="n">formula_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
                <span class="n">out_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;final_&#39;</span><span class="p">,</span> <span class="n">warn_about_unused_setts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parse a formula specification to a formula object of the given logic.&quot;&quot;&quot;</span>
    <span class="n">logic</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Logic</span> <span class="o">=</span> <span class="n">get_logic</span><span class="p">(</span><span class="n">fuzzy_logic_key</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">,</span>
                                         <span class="n">warn_about_unused_setts</span><span class="o">=</span><span class="n">warn_about_unused_setts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">parser</span><span class="p">()(</span><span class="n">formula_spec</span><span class="p">,</span> <span class="n">out_key</span><span class="o">=</span><span class="n">out_key</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="s1">&#39;noop&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_formula_obj"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_formula_obj.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_formula_obj">[docs]</a><span class="k">def</span> <span class="nf">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">parse</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;necessary&#39;</span><span class="p">,</span> <span class="n">formula_spec</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parse a formula object from the settings in sacred experiment ``conf`` or load the original formula object.</span>
<span class="sd">    Uses keys-value-pairs ``predicate_setts`` (or legacy ``ispartofa_setts``), ``fuzzy_logic_key``, ``formula_spec``.&quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_formula_spec&#39;</span><span class="p">]:</span> <span class="s1">&#39;gt_formula&#39;</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;formula_spec&#39;</span><span class="p">]:</span> <span class="s1">&#39;formula&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">parse</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">parse</span> <span class="o">==</span> <span class="s1">&#39;necessary&#39;</span> <span class="ow">and</span> <span class="n">formula_spec</span> <span class="ow">and</span> <span class="n">formula_spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">):</span>
        <span class="n">formula_spec</span> <span class="o">=</span> <span class="n">formula_spec</span> <span class="ow">or</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;formula_spec&#39;</span><span class="p">]</span>
        <span class="n">logic</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Logic</span> <span class="o">=</span> <span class="n">get_logic_from_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="n">formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="o">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">parser</span><span class="p">()(</span><span class="n">formula_spec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;formula&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">formula_spec</span> <span class="k">else</span> <span class="n">keys</span><span class="p">[</span><span class="n">formula_spec</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find original formula of spec </span><span class="si">{}</span><span class="s2"> in conf for spec </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">formula_spec</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;formula_spec&#39;</span><span class="p">]))</span>
        <span class="c1"># Fix legacy formulas and issues from depickling</span>
        <span class="n">formula_obj</span> <span class="o">=</span> <span class="n">fix_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;fuzzy_logic_key&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">formula_obj</span></div>


<div class="viewcode-block" id="fix_formula_obj"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.fix_formula_obj.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.fix_formula_obj">[docs]</a><span class="k">def</span> <span class="nf">fix_formula_obj</span><span class="p">(</span><span class="n">formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">,</span> <span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fix loaded objects from legacy experiments.</span>
<span class="sd">    Changes that require fix:</span>

<span class="sd">    - introduction of cache_duplicates attribute.</span>
<span class="sd">    - logical_and attributes were turned into OrderedDict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_formula_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_inter_store</span> <span class="o">=</span> <span class="p">[</span><span class="n">formula_obj</span><span class="p">]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">_inter_store</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_inter_store</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_formula_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">_inter_store</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">in_keys</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;logical_and&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">logical_and</span> <span class="o">=</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">logic_by_name</span><span class="p">(</span>
                    <span class="n">fuzzy_logic_key</span><span class="p">)</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s2">&quot;AND&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_inter_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">logical_and</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;logical_or&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">logical_or</span> <span class="o">=</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">logic_by_name</span><span class="p">(</span>
                    <span class="n">fuzzy_logic_key</span><span class="p">)</span><span class="o">.</span><span class="n">logical_</span><span class="p">(</span><span class="s2">&quot;OR&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_inter_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">logical_or</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_formula_objs</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">cache_duplicates</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># In some strange cases it seems like the dim info gets lost from sacred pickling:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">quantifiers</span><span class="o">.</span><span class="n">AbstractQuantifier</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">formula_obj</span></div>


<div class="viewcode-block" id="to_bool_predicates"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.to_bool_predicates.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.to_bool_predicates">[docs]</a><span class="k">def</span> <span class="nf">to_bool_predicates</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">,</span> <span class="n">thresh_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace all occurences of predicate variables by a boolean version binarized at ``thresh_key``.</span>
<span class="sd">    Returns a new formula object.&quot;&quot;&quot;</span>
    <span class="n">thresh_key</span> <span class="o">=</span> <span class="n">thresh_key</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;if_boolean_binarize_preds_at&#39;</span><span class="p">]</span>
    <span class="n">to_replace</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;concept_pretty_names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="o">*</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;concept_pretty_names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                  <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pedestrian_key&quot;</span><span class="p">]]</span>
    <span class="n">replace_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&gt;=</span><span class="si">{</span><span class="n">thresh_key</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">to_replace</span><span class="p">}</span>
    <span class="n">bool_formula_obj</span> <span class="o">=</span> <span class="n">formula_obj</span><span class="o">.</span><span class="n">treerecurse_replace_keys</span><span class="p">(</span><span class="o">**</span><span class="n">replace_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bool_formula_obj</span></div>


<div class="viewcode-block" id="FormulaIDInfo"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaIDInfo.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaIDInfo">[docs]</a><span class="k">class</span> <span class="nc">FormulaIDInfo</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span>
    <span class="sd">&quot;&quot;&quot;The (parsed) formula object.&quot;&quot;&quot;</span>
    <span class="n">spec</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The string specification of the formula object.&quot;&quot;&quot;</span>
    <span class="n">pretty_spec</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The pretty string specification of the formula object.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;A unique ID for the formula object taking into account the formula spec, logic, and constants.&quot;&quot;&quot;</span>
    <span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;The hash of the ``id``.&quot;&quot;&quot;</span>
    <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;A unique experiment directory path based on the ``id`` and its ``hash``.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="formula_spec_to_dir"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.formula_spec_to_dir.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.formula_spec_to_dir">[docs]</a><span class="k">def</span> <span class="nf">formula_spec_to_dir</span><span class="p">(</span><span class="n">formula_spec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span> <span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">use_all_setts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">maxlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
                        <span class="n">formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Legacy shortcut for ``formula_spec_to_idinfo(...).dir``.&quot;&quot;&quot;</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">FormulaIDInfo</span> <span class="o">=</span> <span class="n">formula_spec_to_idinfo</span><span class="p">(</span>
        <span class="n">formula_spec</span><span class="o">=</span><span class="n">formula_spec</span><span class="p">,</span> <span class="n">formula_obj</span><span class="o">=</span><span class="n">formula_obj</span><span class="p">,</span>
        <span class="n">fuzzy_logic_key</span><span class="o">=</span><span class="n">fuzzy_logic_key</span><span class="p">,</span>
        <span class="n">constants</span><span class="o">=</span><span class="n">constants</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="o">=</span><span class="n">predicate_setts</span><span class="p">,</span> <span class="n">use_all_setts</span><span class="o">=</span><span class="n">use_all_setts</span><span class="p">,</span>
        <span class="n">maxlen</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span><span class="o">.</span><span class="n">dir</span></div>


<div class="viewcode-block" id="formula_spec_to_idinfo"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.formula_spec_to_idinfo.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.formula_spec_to_idinfo">[docs]</a><span class="k">def</span> <span class="nf">formula_spec_to_idinfo</span><span class="p">(</span><span class="n">formula_spec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">formula_obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">use_all_setts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">maxlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FormulaIDInfo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return a unique infos on the given ``formula_spec`` based on the formula, logic, and constants.</span>
<span class="sd">    The ``dir`` path is determined by the ID of the formula (see :py:func:`formula_spec_to_idinfo`),</span>
<span class="sd">    and the used fuzzy logic.</span>
<span class="sd">    The format of the folder name is:</span>
<span class="sd">    ``f&quot;{f_id[:(maxlen-10)]}..{f_id_md5hash[:8]}/{fuzzy_logic_key}&quot;``</span>

<span class="sd">    :param formula_spec: formula object or string</span>
<span class="sd">    :param fuzzy_logic_key: identifier for fuzzy logic;</span>
<span class="sd">        also used to parse ``formula_spec`` if that is a str</span>
<span class="sd">    :param constants: key-value pairs of grounded variables</span>
<span class="sd">    :param predicate_setts: collection of predicate settings of the format</span>
<span class="sd">        ``{pred_symbol: {init_key: init_val}}``</span>
<span class="sd">    :param use_all_setts: legacy setting to use all ``constants`` and</span>
<span class="sd">        ``predicate_setts`` entries without filtering</span>
<span class="sd">    :param maxlen: maximum total length of the string</span>
<span class="sd">    :param formula_obj: alternative to setting ``formula_spec`` for compatibility</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fuzzy_logic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fuzzy_logic_key must be given.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">formula_spec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">formula_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either formula_spec of formula_obj must be given.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Formula object</span>
    <span class="n">formula_obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="n">formula_obj</span> <span class="ow">or</span> <span class="n">formula_spec</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formula_obj</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">):</span>
        <span class="n">formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">formula_spec</span><span class="p">,</span> <span class="n">fuzzy_logic_key</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">)</span>

    <span class="c1"># String and pretty string spec for formula</span>
    <span class="n">formula_spec</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">formula_obj</span><span class="p">)</span>
    <span class="n">formula_pretty_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">formula_obj</span><span class="o">.</span><span class="n">to_pretty_str</span><span class="p">()</span>

    <span class="c1"># Filter constants and predicate_setts</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_all_setts</span><span class="p">:</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="p">{</span><span class="n">con</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">con</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">con</span> <span class="ow">in</span> <span class="n">formula_pretty_str</span><span class="p">}</span>
        <span class="n">predicate_setts</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="n">symb</span><span class="p">:</span> <span class="n">setts</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="n">formula_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">formula_obj</span><span class="o">.</span><span class="n">all_children</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">symb</span><span class="p">,</span> <span class="n">setts</span> <span class="ow">in</span> <span class="n">_filter_predicate_setts</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                           <span class="o">**</span><span class="p">({</span><span class="s1">&#39;_&#39;</span><span class="p">:</span> <span class="n">predicate_setts</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">]}</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">predicate_setts</span> <span class="k">else</span> <span class="p">{})}</span>
    <span class="c1"># Pretty strings for constants and predicate_setts</span>
    <span class="n">consts</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">items</span><span class="p">())]))</span> <span class="k">if</span> <span class="n">constants</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">pred_setts</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;predicate_setts.</span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">setts</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
                                       <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">setts</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">predicate_setts</span><span class="o">.</span><span class="n">items</span><span class="p">())]))</span> <span class="k">if</span> <span class="n">predicate_setts</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># ID string</span>
    <span class="n">formula_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">formula_pretty_str</span> <span class="o">+</span> <span class="n">consts</span> <span class="o">+</span> <span class="n">pred_setts</span>

    <span class="c1"># Calc hash and print &lt;first part of str&gt;_&lt;first 8 digits of hex hash&gt;</span>
    <span class="n">formula_id_hash</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">formula_id</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">formula_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">formula_id</span><span class="p">[:</span><span class="n">maxlen</span> <span class="o">-</span> <span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s1">..</span><span class="si">{</span><span class="n">formula_id_hash</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">fuzzy_logic_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FormulaIDInfo</span><span class="p">(</span>
        <span class="n">obj</span><span class="o">=</span><span class="n">formula_obj</span><span class="p">,</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">formula_spec</span><span class="p">,</span>
        <span class="n">pretty_spec</span><span class="o">=</span><span class="n">formula_pretty_str</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">formula_id</span><span class="p">,</span>
        <span class="nb">hash</span><span class="o">=</span><span class="n">formula_id_hash</span><span class="p">,</span>
        <span class="nb">dir</span><span class="o">=</span><span class="n">formula_dir</span><span class="p">,</span>
    <span class="p">)</span></div>

<span class="c1"># ====================</span>
<span class="c1"># DATA HANDLING</span>
<span class="c1"># ====================</span>

<div class="viewcode-block" id="SwapTupleArgs"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.SwapTupleArgs.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.SwapTupleArgs">[docs]</a><span class="k">class</span> <span class="nc">SwapTupleArgs</span><span class="p">(</span><span class="n">trafos</span><span class="o">.</span><span class="n">TupleTransforms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Swap the two arguments in a tuple.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SwapTupleArgs.apply_to"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.SwapTupleArgs.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.SwapTupleArgs.apply_to">[docs]</a>    <span class="k">def</span> <span class="nf">apply_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Swap target and input.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">inp</span></div></div>


<div class="viewcode-block" id="KeypointsDatasetWithDesc"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.KeypointsDatasetWithDesc.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.KeypointsDatasetWithDesc">[docs]</a><span class="k">class</span> <span class="nc">KeypointsDatasetWithDesc</span><span class="p">(</span><span class="n">coco</span><span class="o">.</span><span class="n">KeypointsDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around coco dataset class returning tuples of ``(descriptor, (image, anns))``.</span>
<span class="sd">    Default trafo turns images into tensors, anns into mask tensors and resizes all to ``img_size``.</span>
<span class="sd">    In case a transform is given that should apply on ``(image, anns)``,</span>
<span class="sd">    don&#39;t forget to use a ``trafos.UnfoldTuple()`` transform.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="KeypointsDatasetWithDesc.__init__"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.KeypointsDatasetWithDesc.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.KeypointsDatasetWithDesc.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">use_boxes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">reduce_gt_masks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overwrite the default transform.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Turn annotations into masks and resize</span>
        <span class="n">anns_to_seg_trafo</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">COCOBoxToSegMask</span><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span> <span class="n">merge_masks</span><span class="o">=</span><span class="n">reduce_gt_masks</span><span class="p">)</span>\
            <span class="k">if</span> <span class="n">use_boxes</span> <span class="k">else</span> <span class="n">coco</span><span class="o">.</span><span class="n">COCOSegToSegMask</span><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span> <span class="n">merge_masks</span><span class="o">=</span><span class="n">reduce_gt_masks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">OnTarget</span><span class="p">(</span>
            <span class="p">(</span><span class="n">trafos</span><span class="o">.</span><span class="n">UnfoldTuple</span><span class="p">()</span>
             <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span>  <span class="c1"># pad and resize to img_size</span>
             <span class="o">+</span> <span class="n">trafos</span><span class="o">.</span><span class="n">OnTarget</span><span class="p">(</span><span class="n">anns_to_seg_trafo</span><span class="p">)</span>
             <span class="o">+</span> <span class="n">trafos</span><span class="o">.</span><span class="n">OnBothSides</span><span class="p">(</span><span class="n">trafos</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))))</span></div>

<div class="viewcode-block" id="KeypointsDatasetWithDesc.getitem"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.KeypointsDatasetWithDesc.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.KeypointsDatasetWithDesc.getitem">[docs]</a>    <span class="k">def</span> <span class="nf">getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Return tuple of ``(descriptor, (image, anns))``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_default_after_cache_trafo</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_data_loader_for"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_data_loader_for.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_data_loader_for">[docs]</a><span class="k">def</span> <span class="nf">get_data_loader_for</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">BaseDataset</span><span class="p">,</span> <span class="n">loader_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
                        <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">],</span> <span class="n">show_progress_bars</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uncaptured version of ``get_data_loader``.&quot;&quot;&quot;</span>
    <span class="n">dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="n">train_eval</span><span class="o">.</span><span class="n">loader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="o">**</span><span class="n">loader_setts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_progress_bars</span><span class="p">:</span>
        <span class="n">dataloader</span><span class="p">:</span> <span class="n">tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataloader</span></div>


<div class="viewcode-block" id="get_data"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_data.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_data">[docs]</a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">img_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">dataset_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_person_sizes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">reduce_gt_masks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">show_progress_bars</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">use_boxes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">_log</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">coco</span><span class="o">.</span><span class="n">KeypointsDataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return data triple of COCO keypoint datasets</span>
<span class="sd">    with output transformed to semantic segmentation of persons.</span>
<span class="sd">    Allow to subset the annotations to only contain persons of a certain</span>
<span class="sd">    estimated relative ``(min, max)`` size range.</span>
<span class="sd">    Cache subsetted annotations.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">dataset_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dataset_root</span><span class="p">)</span>
    <span class="n">person_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span> \
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">default_person_sizes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">predicate_setts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;person_size_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> \
        <span class="k">else</span> <span class="n">default_person_sizes</span><span class="p">[</span><span class="n">predicate_setts</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">][</span><span class="s1">&#39;person_size_key&#39;</span><span class="p">]]</span>
    <span class="n">reduce_gt_masks</span> <span class="o">=</span> <span class="n">reduce_gt_masks</span> <span class="k">if</span> <span class="n">reduce_gt_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
        <span class="n">predicate_setts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reduce_gt_masks&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">img_base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TRAIN_VAL&#39;</span><span class="p">:</span> <span class="s1">&#39;train2017&#39;</span><span class="p">,</span> <span class="s1">&#39;TEST&#39;</span><span class="p">:</span> <span class="s1">&#39;val2017&#39;</span><span class="p">}[</span><span class="n">split</span><span class="p">]</span>
    <span class="n">imgs_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_root</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">img_base</span><span class="p">)</span>
    <span class="n">ann_fp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">dataset_root</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;person_keypoints_&quot;</span> <span class="o">+</span> <span class="n">coco</span><span class="o">.</span><span class="n">ConceptDataset</span><span class="o">.</span><span class="n">settings_to_str</span><span class="p">(</span>
            <span class="n">dataset_root</span><span class="o">=</span><span class="n">imgs_root</span><span class="p">,</span>
            <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
            <span class="n">person_rel_size_range</span><span class="o">=</span><span class="n">person_size</span>
        <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ann_fp</span><span class="p">):</span>  <span class="c1"># load from file without subsetting</span>
        <span class="n">condition</span><span class="p">,</span> <span class="n">annotations_fp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ann_fp</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># enable subsetting by person size</span>
        <span class="n">annotations_fp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">person_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
            <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">person_has_rel_size</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">min_rel_height</span><span class="o">=</span><span class="n">person_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">max_rel_height</span><span class="o">=</span><span class="n">person_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_target_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">)</span>

    <span class="c1"># Actual data acquisition</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading and subsetting dataset split </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span> <span class="k">if</span> <span class="n">_log</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">KeypointsDatasetWithDesc</span> <span class="o">=</span> <span class="n">KeypointsDatasetWithDesc</span><span class="p">(</span>
        <span class="n">dataset_root</span><span class="o">=</span><span class="n">imgs_root</span><span class="p">,</span>
        <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
        <span class="n">annotations_fp</span><span class="o">=</span><span class="n">annotations_fp</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">use_boxes</span><span class="o">=</span><span class="n">use_boxes</span><span class="p">,</span>
        <span class="n">reduce_gt_masks</span><span class="o">=</span><span class="n">reduce_gt_masks</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">annotations_fp</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span>
                                 <span class="n">show_progress_bar</span><span class="o">=</span><span class="n">show_progress_bars</span><span class="p">,</span>
                                 <span class="n">license_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Annotations caching</span>
    <span class="k">if</span> <span class="n">person_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> \
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ann_fp</span><span class="p">):</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">to_raw_anns</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Subset of MS COCO dataset with persons of relative size in&quot;</span>
            <span class="s2">&quot; the range [</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">] assuming images are padded &amp; scaled &quot;</span>
            <span class="s2">&quot;to HxW=</span><span class="si">{}</span><span class="s2">x</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">person_size</span><span class="p">,</span> <span class="o">*</span><span class="n">img_size</span><span class="p">),</span>
                            <span class="n">save_as</span><span class="o">=</span><span class="n">ann_fp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span></div>

<span class="c1"># ====================</span>
<span class="c1"># RESULTS HANDLING</span>
<span class="c1"># ====================</span>

<div class="viewcode-block" id="save_metrics_to"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.save_metrics_to.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.save_metrics_to">[docs]</a><span class="k">def</span> <span class="nf">save_metrics_to</span><span class="p">(</span><span class="n">metric_vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                    <span class="n">metrics_logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metrics_logdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">log_scalar</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Save dict ``{metric_name: val}`` to ``metrics_logdir/metrics.csv`` and/or using ``log_scalar`` method.</span>
<span class="sd">    Return two dicts, on with the numerical values, one with the figures contained in ``metric_vals`` dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># clean up types, especially tensors</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">metric_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">val</span>
        <span class="n">metric_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">numeric_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metric_vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>

    <span class="c1"># csv log of numeric values</span>
    <span class="n">metrics_logfile</span> <span class="o">=</span> <span class="n">metrics_logfile</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_logdir</span><span class="p">,</span> <span class="s1">&#39;metrics.csv&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">metrics_logdir</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metrics_logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metrics_logfile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s2">&quot;Log CSV file </span><span class="si">{}</span><span class="s2"> already exists!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metrics_logfile</span><span class="p">))</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">numeric_data</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">metrics_logfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># sacred log</span>
    <span class="k">if</span> <span class="n">log_scalar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">quant_name</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">numeric_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_scalar</span><span class="p">(</span><span class="n">quant_name</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="c1"># fig logs</span>
    <span class="n">figs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metric_vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">metrics_logdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_logdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_logdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">))</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_logdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">.pt&#39;</span><span class="p">))</span>  <span class="c1"># enable later recovery of figure values</span>
    
    <span class="k">return</span> <span class="n">numeric_data</span><span class="p">,</span> <span class="n">figs</span></div>


<div class="viewcode-block" id="default_logdir"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.default_logdir.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.default_logdir">[docs]</a><span class="k">def</span> <span class="nf">default_logdir</span><span class="p">(</span><span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the default logging directory root.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="c1"># metrics logging dir</span>
        <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;experiment_root&quot;</span><span class="p">],</span>
        <span class="n">formula_spec_to_dir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;formula_spec&quot;</span><span class="p">],</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;fuzzy_logic_key&quot;</span><span class="p">],</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;constants&quot;</span><span class="p">],</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;predicate_setts&quot;</span><span class="p">]),</span>
    <span class="p">)</span></div>


<span class="c1"># ====================</span>
<span class="c1"># MODEL HANDLING AND CACHING</span>
<span class="c1"># ====================</span>

<div class="viewcode-block" id="get_predicates"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_predicates.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.get_predicates">[docs]</a><span class="k">def</span> <span class="nf">get_predicates</span><span class="p">(</span><span class="n">concept_model_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">concept_model_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                   <span class="n">concept_to_layer</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">concept_pretty_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                   <span class="n">pedestrian_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="c1"># For loading models via config and model registry:</span>
                   <span class="n">_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="c1"># For handing over models directly:</span>
                   <span class="n">main_model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">main_model_trafo</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="o">**</span><span class="n">_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the predicate function: Takes an image and returns a dict with all predicate values.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">model_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">main_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">main_model_trafo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">concept_model_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">concept_model_root</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="c1"># Concept models (with sigmoid activation)</span>
    <span class="n">c_models_by_layer</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConceptModel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">l_id</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">l_id</span> <span class="ow">in</span> <span class="n">concept_to_layer</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">concept_name</span><span class="p">,</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">concept_to_layer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">c_emb</span><span class="p">:</span> <span class="n">ConceptEmbedding</span> <span class="o">=</span> <span class="n">ca_exp_eval</span><span class="o">.</span><span class="n">get_best_emb</span><span class="p">(</span>
            <span class="n">layer_id</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">ca_exp_eval</span><span class="o">.</span><span class="n">analysis_root</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="n">concept_name</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">concept_model_root</span><span class="p">))</span>
        <span class="n">c_model</span> <span class="o">=</span> <span class="n">ConceptModel</span><span class="o">.</span><span class="n">from_embedding</span><span class="p">(</span><span class="n">c_emb</span><span class="p">,</span> <span class="n">legacy_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">concept_model_args</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">c_model</span><span class="o">.</span><span class="n">concept_name</span> <span class="o">==</span> <span class="n">concept_name</span><span class="p">,</span> \
            <span class="s2">&quot;concept_name for model </span><span class="si">{}</span><span class="s2"> differs from the one used for loading </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_model</span><span class="p">,</span> <span class="n">concept_name</span><span class="p">)</span>
        <span class="n">c_models_by_layer</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">concept_pretty_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">concept_name</span><span class="p">,</span> <span class="n">concept_name</span><span class="p">):</span> <span class="n">c_model</span><span class="p">})</span>

    <span class="c1"># Main model</span>
    <span class="n">main_model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">main_model</span> <span class="ow">or</span> \
        <span class="n">get_model</span><span class="p">(</span><span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">layer_infos</span><span class="o">=</span><span class="n">c_models_by_layer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">_config</span><span class="p">)</span>
    <span class="n">main_model_trafo</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">main_model_trafo</span> <span class="ow">or</span> \
        <span class="n">get_model</span><span class="p">(</span><span class="n">model_key</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s1">_trafo&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">_config</span><span class="p">,</span> <span class="n">check_layer_infos</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Joint model: return dict of {&#39;concept&#39;: seg_mask, ...} (the predicate values)</span>
    <span class="n">predicates</span><span class="p">:</span> <span class="n">model_extension</span><span class="o">.</span><span class="n">ModelExtender</span> <span class="o">=</span> <span class="n">model_extension</span><span class="o">.</span><span class="n">ModelExtender</span><span class="p">(</span>
        <span class="n">main_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">return_orig_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">pedestrian_key</span><span class="p">:</span> <span class="n">main_model_trafo</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)},</span>
            <span class="o">**</span><span class="n">c_models_by_layer</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">predicates</span></div>


<div class="viewcode-block" id="default_uncollate"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.default_uncollate.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.default_uncollate">[docs]</a><span class="k">def</span> <span class="nf">default_uncollate</span><span class="p">(</span><span class="n">batch_out</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span>
                      <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;Uncollate a batch of predicate outputs previously collated by torch default_collate&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_out</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">batch_out</span>  <span class="c1"># tensor already is iterable over batch</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_out</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">batch_out</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch_out</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Uncollate currently only defined for dict but got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">batch_out</span><span class="p">)))</span></div>


<div class="viewcode-block" id="cached_eval"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.cached_eval.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.cached_eval">[docs]</a><span class="k">def</span> <span class="nf">cached_eval</span><span class="p">(</span><span class="n">descriptors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">input_batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                <span class="n">model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]],</span>
                <span class="n">cache</span><span class="p">:</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given ``descriptors`` load ``model`` outputs either from ``cache``</span>
<span class="sd">    or generate them from ``input_batch``.&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="c1"># load from cache if possible:</span>
    <span class="n">cached_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">load_batch</span><span class="p">(</span><span class="n">descriptors</span><span class="p">)</span> \
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">cached_out</span><span class="p">:</span>
        <span class="n">model_out</span> <span class="o">=</span> <span class="n">default_collate</span><span class="p">(</span><span class="n">cached_out</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># else evaluate predicates</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">input_batch</span> <span class="o">=</span> <span class="n">input_batch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">model_out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_batch</span><span class="p">)</span>
        <span class="c1"># stack c-model list output</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_out</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">model_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>  <span class="c1"># TODO: remove special treatment for concepts</span>
                         <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_out</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="c1"># put</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">put_batch</span><span class="p">(</span><span class="n">descriptors</span><span class="p">,</span> <span class="n">default_uncollate</span><span class="p">(</span><span class="n">model_out</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model_out</span></div>


<div class="viewcode-block" id="mask_cache"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.mask_cache.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.mask_cache">[docs]</a><span class="k">def</span> <span class="nf">mask_cache</span><span class="p">(</span><span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results_cache_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Standard mask cache.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results_cache_dir</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">caching</span><span class="o">.</span><span class="n">NoCache</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">caching</span><span class="o">.</span><span class="n">PTCache</span><span class="p">(</span><span class="n">cache_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_cache_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">),</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>
                           

<div class="viewcode-block" id="predicates_cache_for"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.predicates_cache_for.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.predicates_cache_for">[docs]</a><span class="k">def</span> <span class="nf">predicates_cache_for</span><span class="p">(</span><span class="n">concept_to_layer</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">concept_pretty_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                         <span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pedestrian_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">results_cache_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">reduce_pred_masks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">caching</span><span class="o">.</span><span class="n">CacheDict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provide caches with folder structure ``&lt;pedestrian_key&gt;/&lt;logic&gt;/*.pt`` and ``&lt;concept&gt;/&lt;layer&gt;/*.pt``&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="s1">&#39;cpu&#39;</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">results_cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">results_cache_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reduce_pred_masks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reduce_pred_masks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicate_setts</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reduce_pred_masks&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">pred_cache</span><span class="p">:</span> <span class="n">caching</span><span class="o">.</span><span class="n">CacheDict</span> <span class="o">=</span> <span class="n">caching</span><span class="o">.</span><span class="n">CacheDict</span><span class="p">({</span>
        <span class="n">pedestrian_key</span><span class="p">:</span> <span class="n">mask_cache</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pedestrian_key</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;_unreduced&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">reduce_pred_masks</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                       <span class="n">fuzzy_logic_key</span><span class="p">),</span>
                                   <span class="n">results_cache_dir</span><span class="o">=</span><span class="n">results_cache_dir</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
        <span class="o">**</span><span class="p">{</span><span class="n">concept_pretty_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">cn</span><span class="p">):</span> <span class="n">mask_cache</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concept_pretty_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">cn</span><span class="p">),</span> <span class="n">l_id</span><span class="p">),</span>
                                                        <span class="n">results_cache_dir</span><span class="o">=</span><span class="n">results_cache_dir</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">l_id</span> <span class="ow">in</span> <span class="n">concept_to_layer</span><span class="o">.</span><span class="n">items</span><span class="p">()}})</span>
    <span class="k">return</span> <span class="n">pred_cache</span></div>


<div class="viewcode-block" id="formula_trafo_caches_for"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.formula_trafo_caches_for.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.formula_trafo_caches_for">[docs]</a><span class="k">def</span> <span class="nf">formula_trafo_caches_for</span><span class="p">(</span><span class="n">formulas_to_cache</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">fuzzy_logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">predicate_setts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
                             <span class="n">results_cache_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">keys_allowed_from</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">disable_formula_caching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">_log</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Get caches for formula transformation outputs.&quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="s1">&#39;cpu&#39;</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">results_cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">results_cache_dir</span><span class="p">)</span>
    <span class="c1"># Cache structure: &lt;formula&gt;_&lt;constants&gt;/&lt;logic&gt;/*.pt</span>
    <span class="k">if</span> <span class="n">disable_formula_caching</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Filter out keys not occurring as child</span>
    <span class="n">keys_allowed_from</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">keys_allowed_from</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">)]</span>
    <span class="n">allowed_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">keys_allowed_from</span> <span class="k">else</span> \
        <span class="nb">set</span><span class="p">([</span><span class="n">child</span><span class="o">.</span><span class="n">out_key</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">keys_allowed_from</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">all_children</span><span class="p">]</span> \
            <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">out_key</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">keys_allowed_from</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">keys_allowed_from</span><span class="p">])</span>
    <span class="c1"># Collect caches</span>
    <span class="n">caches</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">formula_spec</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">formulas_to_cache</span><span class="p">):</span>
        <span class="n">curr_formula</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">formula_spec</span><span class="p">,</span> <span class="n">fuzzy_logic_key</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">)</span>
        <span class="n">curr_formula_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">curr_formula</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_log</span> <span class="ow">and</span> <span class="n">allowed_keys</span> <span class="ow">and</span> <span class="n">curr_formula_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
            <span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Intermediate formula string specified for caching is no intermediate output: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="n">curr_formula_str</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Cache structure: &lt;gt_formula&gt;_&lt;constants&gt;/&lt;logic&gt;/*.pt</span>
        <span class="n">caches</span><span class="p">[</span><span class="n">curr_formula_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_cache</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">formula_spec_to_dir</span><span class="p">(</span>
            <span class="n">curr_formula</span><span class="p">,</span> <span class="n">fuzzy_logic_key</span><span class="p">,</span> <span class="n">constants</span><span class="p">,</span> <span class="n">predicate_setts</span><span class="p">),</span>
            <span class="n">results_cache_dir</span><span class="o">=</span><span class="n">results_cache_dir</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">caches</span></div>


<div class="viewcode-block" id="FormulaEvaluator"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator">[docs]</a><span class="k">class</span> <span class="nc">FormulaEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Evaluate predicates and formulas with intermediate values cached according to a config.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FormulaEvaluator.__init__"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">formulas</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">additional_formulas</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">predicates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">formula_caches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">predicates_cache</span><span class="p">:</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">changed_constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">changed_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init.</span>
<span class="sd">        To disable caching, set ``conf[&#39;results_cache_dir&#39;]=None`` or assign ``caching.NoCache()``</span>
<span class="sd">        to ``formula_caches`` and ``predicates_cache``.</span>
<span class="sd">        </span>
<span class="sd">        :param conf: the experiment config to use for setting defaults;</span>
<span class="sd">            may be skipped if all other settings are given</span>
<span class="sd">        :param formulas: the formulas to evaluate (see :py:attr:`formulas`);</span>
<span class="sd">            defaults to ``[conf[&#39;formula&#39;], conf[&#39;gt_formula&#39;]]``;</span>
<span class="sd">            may be given as dict ``{new_out_key: formula_object}`` or as sequence of formula objects,</span>
<span class="sd">            in which case the ``formula.out_key`` is used as ``new_out_key``.</span>
<span class="sd">        :param additional_formulas: add these to ``formulas`` (after setting defaults to ``formulas``);</span>
<span class="sd">            as ``formulas``, may be dict or sequence</span>
<span class="sd">        :param predicates: the predicates model (see :py:attr:`predicates`);</span>
<span class="sd">            defaults to the output of :py:func:`get_predicates`</span>
<span class="sd">        :param formula_caches: dictionary of ``{out_key: cache}`` for caching formula (intermediate)</span>
<span class="sd">            outputs (see :py:attr:`formula_caches`);</span>
<span class="sd">            defaults to output of :py:func:`formula_trafo_caches_for`;</span>
<span class="sd">            set to ``{}`` to disable</span>
<span class="sd">        :param predicates_cache: the cache used for the ``predicates`` outputs;</span>
<span class="sd">            defaults to output of :py:func:`predicates_cache_for`;</span>
<span class="sd">            set to ``caching.NoCache()`` to disable</span>
<span class="sd">        :param constants: constants to use; defaults to ``conf[&#39;constants&#39;]``</span>
<span class="sd">        :param changed_constants: update ``constants`` (also default value)</span>
<span class="sd">        :param changed_root: prepend ``changed_root`` to all used paths from ``conf``</span>
<span class="sd">        :param device: device to use for evaluation;</span>
<span class="sd">            defaults to ``conf[&#39;device&#39;]``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;The configuration mapping used to produce any default settings.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The device to use for evaluation.&quot;&quot;&quot;</span>
        
        <span class="c1"># Predicates &amp; Caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicates</span> <span class="ow">or</span> <span class="n">get_predicates</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="n">changed_root</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">},</span> <span class="n">_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The model producing the dictionary of predicate outputs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicates_cache</span><span class="p">:</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span> <span class="o">=</span> <span class="n">predicates_cache</span> <span class="ow">or</span> <span class="n">predicates_cache_for</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">changed_root</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Cache for predicate outputs.&quot;&quot;&quot;</span>

        <span class="c1"># Constants</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="n">constants</span> <span class="k">if</span> <span class="n">constants</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;constants&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">constants</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">changed_constants</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="sd">&quot;&quot;&quot;The constants to supply to the formula evaluation.</span>
<span class="sd">        Have higher precendence than newly calculated predicate outputs.&quot;&quot;&quot;</span>

        <span class="c1"># Formulas &amp; Caches</span>
        <span class="n">to_dict</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fs</span><span class="p">:</span> <span class="n">fs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">}</span>
        <span class="n">formulas</span> <span class="o">=</span> <span class="n">formulas</span> <span class="ow">or</span> <span class="p">[</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="o">*</span><span class="p">([</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">formula_spec</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_formula_spec&#39;</span><span class="p">])]</span> <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_formula_spec&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">{</span><span class="o">**</span><span class="n">to_dict</span><span class="p">(</span><span class="n">formulas</span><span class="p">),</span> <span class="o">**</span><span class="n">to_dict</span><span class="p">(</span><span class="n">additional_formulas</span> <span class="ow">or</span> <span class="p">{})}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;The formula objects to evaluate given as dictionary of the form ``{new_out_key: formula_object}``.</span>
<span class="sd">        The ``new_out_key`` is used instead of the ``formula_object.out_key`` for the final output.</span>
<span class="sd">        The latter is only kept if there is a cache registered for it, see :py:attr:`formula_caches`.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">caching</span><span class="o">.</span><span class="n">Cache</span><span class="p">]]</span> <span class="o">=</span> <span class="n">formula_caches</span> <span class="ow">or</span> <span class="n">formula_trafo_caches_for</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="n">changed_root</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">conf</span><span class="p">,</span> <span class="s1">&#39;formulas_to_cache&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;formulas_to_cache&#39;</span><span class="p">,</span> <span class="p">{})})</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of ``{out_key: cache}`` for caching formula (intermediate) outputs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">formula</span><span class="o">.</span><span class="n">keep_keys</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">formula</span><span class="o">.</span><span class="n">keep_keys</span> <span class="ow">or</span> <span class="p">[]),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_same_size</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">SameSizeTensorValues</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicate_setts&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;same_size_mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">used_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The constants actually used in one of the formulas.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">formula</span><span class="o">.</span><span class="n">all_in_keys</span> <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">values</span><span class="p">())}</span>

<div class="viewcode-block" id="FormulaEvaluator.restrict_to_used_constants"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.restrict_to_used_constants">[docs]</a>    <span class="k">def</span> <span class="nf">restrict_to_used_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FormulaEvaluator&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set ``constants`` to a dict only containing the used constants.&quot;&quot;&quot;</span>
        <span class="n">used_constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="n">used_constants</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FormulaEvaluator.calc_results_for"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.calc_results_for">[docs]</a>    <span class="k">def</span> <span class="nf">calc_results_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                         <span class="n">initial_masks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">descs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Hashable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">only_formula_out</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate predicate and formula outputs for a batch of input images.</span>

<span class="sd">        :param images: batch of input images of shape ``[batch, channels, height, width]``</span>
<span class="sd">        :param initial_masks: any further (pre-calculated) inputs to the formula calculation,</span>
<span class="sd">            e.g. the ground truth masks;</span>
<span class="sd">            these take precedence over newly calculated predicate outputs and :py:attr:`constants`</span>
<span class="sd">        :param descs: the descriptors of the images for obtaining respective predicate</span>
<span class="sd">            outputs from :py:attr:`predicates_cache`</span>
<span class="sd">        :param only_formula_out: whether to prune the output to only contain the output values</span>
<span class="sd">            of the formulas from :py:attr:`formulas`</span>
<span class="sd">        :return: dictionary containing the outputs of the formulas as ``{out_key: output}``</span>
<span class="sd">            with ``out_key`` from :py:attr:`formulas`;</span>
<span class="sd">            if ``only_formula_out`` is ``False``, also the following intermediate outputs are added:</span>
<span class="sd">            predicate outputs indexed by the prediate name,</span>
<span class="sd">            all formula outputs and intermediate outputs according to the formula ``keep_keys`` settings</span>
<span class="sd">            (by default, all formula intermediate outputs registered for caching are added to this),</span>
<span class="sd">            all ``initial_masks``,</span>
<span class="sd">            :py:attr:`constants`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calc predicate values</span>
        <span class="n">batch_pred_out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">cached_eval</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predicates_cache</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">calced_formula_inp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_same_size</span><span class="p">({</span>
            <span class="o">**</span><span class="n">batch_pred_out</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="p">,</span> <span class="o">**</span><span class="n">initial_masks</span><span class="p">})</span>

        <span class="c1"># get cached formula (intermediate) outputs</span>
        <span class="n">formula_vals_from_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">load_batch</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">cached_formula_out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">formula_vals_from_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="c1"># evaluate formulas on predicate outputs &amp; ground truth</span>
        <span class="n">all_vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">cached_formula_out</span><span class="p">,</span> <span class="o">**</span><span class="n">calced_formula_inp</span><span class="p">}</span>
        <span class="n">batch_formula_out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">formula_str</span><span class="p">,</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_vals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">formula</span><span class="p">({</span><span class="o">**</span><span class="n">cached_formula_out</span><span class="p">,</span> <span class="o">**</span><span class="n">all_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">calced_formula_inp</span><span class="p">}))</span>
            <span class="c1"># change out_key of formula according to formula_str in formulas</span>
            <span class="n">all_vals</span><span class="p">[</span><span class="n">formula_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_formula_out</span><span class="p">[</span><span class="n">formula_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_vals</span><span class="p">[</span><span class="n">formula</span><span class="o">.</span><span class="n">out_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">formula</span><span class="o">.</span><span class="n">out_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">all_vals</span><span class="p">[</span><span class="n">formula</span><span class="o">.</span><span class="n">out_key</span><span class="p">]</span>
        
        <span class="c1"># store yet uncached stuff:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="p">:</span>
            <span class="n">to_cache</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">all_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">batch_formula_out</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">formula_vals_from_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_cache</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">formula_caches</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">put_batch</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="n">to_cache</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">only_formula_out</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">batch_formula_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_vals</span></div>

<div class="viewcode-block" id="FormulaEvaluator.calc_result_for"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_helpers.FormulaEvaluator.calc_result_for">[docs]</a>    <span class="k">def</span> <span class="nf">calc_result_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                        <span class="n">initial_masks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
                        <span class="n">desc</span><span class="p">:</span> <span class="n">Hashable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">only_formula_out</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around ``calc_results_for`` that handles single inputs instead of a batch.</span>
<span class="sd">        </span>
<span class="sd">        :return: output of :py:meth:`calc_results_for` but with singular batch dimension</span>
<span class="sd">            (first dimension) squeezed for all tensors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_results_for</span><span class="p">(</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">initial_masks</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>
                             <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="p">(</span><span class="n">initial_masks</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">]</span> <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">only_formula_out</span><span class="o">=</span><span class="n">only_formula_out</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Continental Automotive GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>