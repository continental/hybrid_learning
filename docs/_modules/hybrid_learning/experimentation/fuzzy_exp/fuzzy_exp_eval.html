<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval &mdash; hybrid_learning  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/autoclasstoc.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> hybrid_learning
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../userguide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apiref/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">How to contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">hybrid_learning</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright (c) 2022 Continental Automotive GmbH</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Helper functions to evaluate fuzzy logic experiments.</span>
<span class="sd">Includes functions for loading experiment results, post-processing them,</span>
<span class="sd">and to do further evaluations.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">import</span> <span class="nn">PIL.Image</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">hybrid_learning.datasets.transforms</span> <span class="k">as</span> <span class="nn">trafos</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.datasets</span> <span class="kn">import</span> <span class="n">caching</span>
<span class="kn">from</span> <span class="nn">hybrid_learning</span> <span class="kn">import</span> <span class="n">fuzzy_logic</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.experimentation.model_registry.fuzzy_exp_models</span> <span class="kn">import</span> <span class="n">register_all_model_builders</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fuzzy_exp_helpers</span> <span class="k">as</span> <span class="n">calc_helpers</span>
<span class="kn">from</span> <span class="nn">..exp_eval_common</span> <span class="kn">import</span> <span class="n">auc</span><span class="p">,</span> <span class="n">do_for</span><span class="p">,</span> <span class="n">constrain_pd</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">display</span> <span class="o">=</span> <span class="nb">print</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sacred.config</span> <span class="kn">import</span> <span class="n">load_config_file</span> <span class="k">as</span> <span class="n">load_sacred_config_file</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">load_sacred_config_file</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Loading sacred config files requires sacred package to be installed.&quot;</span><span class="p">)</span>

<span class="n">to_tens</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">FIG_SAVE_DIR</span> <span class="o">=</span> <span class="s2">&quot;plots&quot;</span>
<span class="n">PROJECT_ROOT</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;..&quot;</span>

<span class="c1"># Suppress the unnecessary deprecation warning about reusing an axis</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cbook</span><span class="o">.</span><span class="n">mplDeprecation</span><span class="p">)</span>

<span class="n">register_all_model_builders</span><span class="p">()</span>


<span class="c1"># ===============================</span>
<span class="c1"># RAW EXPERIMENT RESULT LOADING</span>
<span class="c1"># ===============================</span>

<div class="viewcode-block" id="get_exp_conf"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.get_exp_conf.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.get_exp_conf">[docs]</a><span class="k">def</span> <span class="nf">get_exp_conf</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conf_validation_vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Get the sacred config dict for the experiment under ``sacred_logdir``.&quot;&quot;&quot;</span>

    <span class="c1"># Select the logdir</span>
    <span class="n">logs_dirnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;_sources&quot;</span><span class="p">]</span>
    <span class="n">completed</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">running</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">log_dirn</span> <span class="ow">in</span> <span class="n">logs_dirnames</span><span class="p">:</span>
        <span class="n">runfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">,</span> <span class="n">log_dirn</span><span class="p">,</span> <span class="s1">&#39;run.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">runfile</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">runfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_dirn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">runfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rfile</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;COMPLETED&#39;</span><span class="p">:</span>
                <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_dirn</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">:</span>
                <span class="n">running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_dirn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_dirn</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> log dirs for failed or interrupted experiments in </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">),</span> <span class="n">sacred_logdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">failed</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">running</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> log dirs for running experiments in </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">running</span><span class="p">),</span> <span class="n">sacred_logdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">running</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found log directories for more than one completed experiment in </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sacred_logdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">completed</span><span class="p">])))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found no log directories for a completed experiment in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">))</span>
    <span class="n">conf_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">,</span> <span class="n">completed</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span>
    <span class="n">conf</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">load_sacred_config_file</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span>

    <span class="c1"># Legacy compatibility</span>
    <span class="k">if</span> <span class="s1">&#39;model_key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span>
        <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;model_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;maskrcnn&#39;</span>

    <span class="c1"># Validation</span>
    <span class="n">formula_infos</span><span class="p">:</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">FormulaIDInfo</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">formula_spec_to_idinfo</span><span class="p">(</span><span class="o">**</span><span class="n">conf</span><span class="p">)</span>

    <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed loading conf for </span><span class="si">{</span><span class="n">sacred_logdir</span><span class="si">}</span><span class="s2">;&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">problem: </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">conf content:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">expected_val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">conf_validation_vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">conf_validation_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]):</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">,</span> <span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Loaded configuration missing key </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">conf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_val</span><span class="p">,</span> <span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;conf[</span><span class="si">{}</span><span class="s2">] (</span><span class="si">{}</span><span class="s2">) != expected_val (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">expected_val</span><span class="p">))</span>
    <span class="n">logdir_root_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">)))</span>
    <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">logdir_root_root</span><span class="p">:</span>
        <span class="n">formula_dir</span> <span class="o">=</span> <span class="n">formula_infos</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">logdir_root_root_front</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">logdir_root_root</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">formula_dir</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">formula_dir</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">logdir_root_root_front</span><span class="p">))]</span> <span class="ow">in</span> <span class="n">logdir_root_root_front</span><span class="p">,</span> \
            <span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;formula_dir (</span><span class="si">{}</span><span class="s2">) not in logdir_root_root (</span><span class="si">{}</span><span class="s2">)&quot;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formula_dir</span><span class="p">,</span> <span class="n">logdir_root_root</span><span class="p">))</span>
    <span class="c1"># Legacy compatibility</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">formula_dir</span> <span class="o">=</span> <span class="n">formula_infos</span><span class="o">.</span><span class="n">id</span>
        <span class="k">assert</span> <span class="n">formula_dir</span> <span class="ow">in</span> <span class="n">logdir_root_root</span><span class="p">,</span> \
            <span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;formula_dir (</span><span class="si">{}</span><span class="s2">) not in logdir_root_root (</span><span class="si">{}</span><span class="s2">)&quot;</span>
                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logdir_root_root</span><span class="p">,</span> <span class="n">formula_dir</span><span class="p">))</span>
    <span class="n">concept_pretty_names</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;concept_pretty_names&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">formula_concept_keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">formula_infos</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">all_in_keys</span> <span class="o">-</span>
                            <span class="p">{</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pedestrian_key&#39;</span><span class="p">],</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                               <span class="s1">&#39;gt_pedestrian_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="o">*</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;constants&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>
    <span class="n">concept_to_layer_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept_pretty_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;concept_to_layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">formula_concept_keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">concept_to_layer_keys</span><span class="p">),</span> \
        <span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;(formula_concept_keys (</span><span class="si">{}</span><span class="s2">) != concept_to_layer_keys (</span><span class="si">{}</span><span class="s2">)&quot;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">formula_concept_keys</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">concept_to_layer_keys</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">conf</span></div>


<span class="n">formula_display_replace</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;LEFT_EYE-RIGHT_EYE&#39;</span><span class="p">:</span> <span class="s1">&#39;eye&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LEFT_LEG-RIGHT_LEG&#39;</span><span class="p">:</span> <span class="s1">&#39;leg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LEFT_ARM-RIGHT_ARM&#39;</span><span class="p">:</span> <span class="s1">&#39;arm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LEFT_WRIST-RIGHT_WRIST&#39;</span><span class="p">:</span> <span class="s1">&#39;wrist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LEFT_ANKLE-RIGHT_ANKLE&#39;</span><span class="p">:</span> <span class="s1">&#39;ankle&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pedestrian&#39;</span><span class="p">:</span> <span class="s1">&#39;person&#39;</span>
<span class="p">}</span>


<div class="viewcode-block" id="formula_to_display_name"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.formula_to_display_name.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.formula_to_display_name">[docs]</a><span class="k">def</span> <span class="nf">formula_to_display_name</span><span class="p">(</span><span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a possibly shortened title version of the given formula string.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">replace_a</span><span class="p">,</span> <span class="n">with_b</span> <span class="ow">in</span> <span class="n">formula_display_replace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">replace_a</span><span class="p">,</span> <span class="n">with_b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_len</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="p">[:</span><span class="n">max_len</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
    <span class="k">return</span> <span class="n">formula</span></div>


<div class="viewcode-block" id="load_orig_and_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.load_orig_and_masks.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.load_orig_and_masks">[docs]</a><span class="k">def</span> <span class="nf">load_orig_and_masks</span><span class="p">(</span><span class="n">img_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">orig_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">imgs_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pedestrian_cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gt_pedestrian_cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">concept_cache_dirs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">final_cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">pedestrian_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pedestrian&quot;</span><span class="p">,</span> <span class="n">gt_pedestrian_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gt_pedestrian&quot;</span><span class="p">,</span>
                        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_pretty_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Load the original image and masks at index ``image_id`` from configured cache directories.</span>

<span class="sd">    :param orig_size: size in ``(height, width)`` to which to pad and resize the original image;</span>
<span class="sd">        if not given defaults to size of pedestrian mask, and no resizing if this is unknown</span>
<span class="sd">    :param final_cache_dir: cache directory for the formula output files</span>
<span class="sd">    :param use_pretty_names: whether to transform mask names using :py:func:`formula_to_display_name`</span>
<span class="sd">    :param pedestrian_key: mask key for person mask</span>
<span class="sd">    :param gt_pedestrian_key: mask key for ground truth person mask</span>
<span class="sd">    :param device: onto which device to load the masks</span>
<span class="sd">    :param raise_on_missing: whether to raise when a mask file is missing or just set the respective value to ``None``</span>
<span class="sd">    :returns: tuple ``(original_image, masks_dict)``</span>
<span class="sd">        with the special mask dict keys ``&#39;formula&#39;`` for the formula mask, and</span>
<span class="sd">        ``pedestrian_key`` for the DNN output.&quot;&quot;&quot;</span>
    <span class="c1"># get images / masks</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">torch_load_from</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">raise_on_missing</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">img_fn</span> <span class="o">+</span> <span class="s1">&#39;.pt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">to_tens</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mandatory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pedestrian_cache_dir</span><span class="p">:</span>
        <span class="n">masks</span><span class="p">[</span><span class="n">pedestrian_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch_load_from</span><span class="p">(</span><span class="n">pedestrian_cache_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gt_pedestrian_cache_dir</span><span class="p">:</span>
        <span class="n">masks</span><span class="p">[</span><span class="n">gt_pedestrian_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch_load_from</span><span class="p">(</span><span class="n">gt_pedestrian_cache_dir</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">concept_cache_dirs</span><span class="p">:</span>
        <span class="n">masks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">c</span><span class="p">:</span> <span class="n">torch_load_from</span><span class="p">(</span><span class="n">c_dir</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">c_dir</span> <span class="ow">in</span> <span class="n">concept_cache_dirs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
    <span class="k">if</span> <span class="n">final_cache_dir</span><span class="p">:</span>
        <span class="n">masks</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch_load_from</span><span class="p">(</span><span class="n">final_cache_dir</span><span class="p">)</span>
    <span class="n">img_t</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">imgs_dir</span><span class="p">:</span>
        <span class="n">orig_img_fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgs_dir</span><span class="p">,</span> <span class="n">img_fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">orig_img_fp</span><span class="p">):</span>
            <span class="n">orig_img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">orig_img_fp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orig_img</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;RGB&#39;</span><span class="p">:</span>
                <span class="n">orig_img</span> <span class="o">=</span> <span class="n">orig_img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
            <span class="n">img_t</span> <span class="o">=</span> <span class="n">to_tens</span><span class="p">(</span><span class="n">orig_img</span><span class="p">)</span>
            <span class="n">orig_size</span> <span class="o">=</span> <span class="n">orig_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">pedestrian_key</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                                      <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pedestrian_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orig_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">img_t</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">pad_and_resize</span><span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">orig_size</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">raise_on_missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">orig_img_fp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_pretty_names</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">img_t</span><span class="p">,</span> <span class="n">masks</span></div>


<div class="viewcode-block" id="get_caches"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.get_caches.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.get_caches">[docs]</a><span class="k">def</span> <span class="nf">get_caches</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">discard_non_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;Given root and config provide the cache arguments needed for ``load_orig_and_masks``&quot;&quot;&quot;</span>
    <span class="n">reduce_pred_masks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;predicate_setts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reduce_pred_masks&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">pred_caches</span><span class="p">:</span> <span class="n">caching</span><span class="o">.</span><span class="n">CacheDict</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">predicates_cache_for</span><span class="p">(</span><span class="o">**</span><span class="n">conf</span><span class="p">,</span> <span class="n">reduce_pred_masks</span><span class="o">=</span><span class="n">reduce_pred_masks</span><span class="p">)</span>
    <span class="n">c_caches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;cache_root&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pred_caches</span><span class="o">.</span><span class="n">cache_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">ped_cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_caches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pedestrian_key&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">formula_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">gt_formula_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">formula_spec</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_formula_spec&#39;</span><span class="p">]))</span>
    <span class="n">formula_caches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">caching</span><span class="o">.</span><span class="n">PTCache</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">formula_trafo_caches_for</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">conf</span><span class="p">,</span> <span class="s1">&#39;formulas_to_cache&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">formula_str</span><span class="p">,</span> <span class="n">gt_formula_str</span><span class="p">]})</span>
    
    <span class="n">other_cache_dirs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">pedestrian_cache_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ped_cache_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">ped_cache_dir</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gt_pedestrian_cache_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">formula_caches</span><span class="p">[</span><span class="n">gt_formula_str</span><span class="p">]</span><span class="o">.</span><span class="n">cache_root</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;gt_pedestrian_key&#39;</span> <span class="ow">in</span> <span class="n">conf</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># and conf[&#39;gt_pedestrian_key&#39;] in calc_helpers.get_formula_obj(conf, parse=False).all_in_keys</span>
        <span class="n">final_cache_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">formula_caches</span><span class="p">[</span><span class="n">formula_str</span><span class="p">]</span><span class="o">.</span><span class="n">cache_root</span><span class="p">),</span>
        <span class="n">imgs_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;dataset_root&#39;</span><span class="p">],</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span>
                            <span class="p">{</span><span class="s1">&#39;TRAIN_VAL&#39;</span><span class="p">:</span> <span class="s1">&#39;train2017&#39;</span><span class="p">,</span> <span class="s1">&#39;TEST&#39;</span><span class="p">:</span> <span class="s1">&#39;val2017&#39;</span><span class="p">}[</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;split&#39;</span><span class="p">]]),</span>
    <span class="p">)</span>
    <span class="n">concept_cache_dirs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">c_caches</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">discard_non_existing</span><span class="p">:</span>
        <span class="n">other_cache_dirs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other_cache_dirs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
        <span class="n">concept_cache_dirs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">concept_cache_dirs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">other_cache_dirs</span><span class="p">,</span> <span class="n">concept_cache_dirs</span><span class="o">=</span><span class="n">concept_cache_dirs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ResultsIterator"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator">[docs]</a><span class="k">class</span> <span class="nc">ResultsIterator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Allow to get all output infos and potentially additionally calculated values for one sample.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ResultsIterator.__init__"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PROJECT_ROOT</span><span class="p">,</span>
                 <span class="n">load_images</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">only_filenames</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">recalc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;necessary&quot;</span><span class="p">,</span>
                 <span class="n">additional_formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">additional_formula_mods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span>
                     <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">changed_constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_pretty_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a sacred experiment ``conf`` dict, yield pairs of</span>
<span class="sd">        image file name, original image, and dict of output masks for that experiment.</span>
<span class="sd">        This is a convenience wrapper around :py:func:`load_orig_and_masks` and :py:func:`recalc_formula_masks`.</span>
<span class="sd">        Included pairs can be restricted by setting the ``only_filenames`` list.</span>
<span class="sd">        Included masks are the concept model outputs and the fuzzy logic formula output.</span>
<span class="sd">        Formula masks may be recalculated or further ones calculated and added via</span>
<span class="sd">        ``additional_formula_mods`` argument.</span>

<span class="sd">        :param conf: the experiment config dict (loaded using ``get_exp_config``)</span>
<span class="sd">        :param root: the root folder in which the experiment was run</span>
<span class="sd">        :param load_images: whether to also load the original images; else set to ``None``</span>
<span class="sd">        :param recalc: whether to recalculate missing ``&#39;formula&#39;`` mask;</span>
<span class="sd">            set to ``True`` or ``&#39;always&#39;`` to always recalculate the formula mask,</span>
<span class="sd">            set to ``False`` or ``None`` to never calculate masks (also disable calculation of ``additional_formula_mods``),</span>
<span class="sd">            set to ``&quot;necessary&quot;`` to calculate ``additional_formula_mods`` and only recalculate missing formula masks.</span>
<span class="sd">        :param additional_formula_mods: dict of callables that accept the original formula object and</span>
<span class="sd">            the ground truth formula object of the experiment, and return a new formula object</span>
<span class="sd">            that shall be calculated (cf. ``recalc``).</span>
<span class="sd">            Recalculated formulas are added to the output masks using the keys from the ``additional_formula_mods`` dict.</span>
<span class="sd">            This can also be used to overwrite the original formula(s) by using the keys</span>
<span class="sd">            ``&#39;formula&#39;`` and ``&#39;gt_formula&#39;``.</span>
<span class="sd">            Example application: For a monitor formula, add its underlying formula body</span>
<span class="sd">            ``{&#39;body&#39;: lambda f, gt_f: f.in_keys[0]}`` (assuming ``f=NOT(some_body)``).</span>
<span class="sd">        :param verbose: in case of recalculation, print some recalcuation information</span>
<span class="sd">        :param use_pretty_names: whether to transform mask names using :py:func:`formula_to_display_name`</span>
<span class="sd">        :param raise_on_missing: see :py:func:`load_orig_and_masks`</span>
<span class="sd">        :yields: tuples of ``(image_filename, (original_image_or_none, dict_of_masks))``;</span>
<span class="sd">            for the format of the second tuple entry have a look at ``load_orig_and_masks``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>

        <span class="c1"># CACHE DIRS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">get_caches</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">discard_non_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">load_images</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">imgs_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_fns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">only_filenames</span> <span class="k">if</span> <span class="n">only_filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="p">[</span><span class="n">img_pt</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.pt&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">img_pt</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">[</span><span class="s1">&#39;pedestrian_cache_dir&#39;</span><span class="p">])]</span>

        <span class="c1"># RECALCULATION SETTINGS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">trafos</span><span class="o">.</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_formulas</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">trafos</span><span class="o">.</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed_constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">changed_constants</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_dict_trafo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">trafos</span><span class="o">.</span><span class="n">DictTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>
        
        <span class="c1"># Feature flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">raise_on_missing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pretty_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">use_pretty_names</span>

        <span class="n">recalc</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">changed_constants</span> <span class="ow">or</span> <span class="n">additional_formula_mods</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span> <span class="k">else</span> <span class="n">recalc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_recalc</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="n">recalc</span><span class="p">,</span> <span class="n">additional_formula_mods</span><span class="o">=</span><span class="n">additional_formula_mods</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ResultsIterator.__len__"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.__len__">[docs]</a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_fns</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResultsIterator.__getitem__"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.__getitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]]:</span>
        <span class="n">img_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">i</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_fns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">img_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_masks</span><span class="p">(</span><span class="n">img_fn</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_prepare_recalc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;necessary&#39;</span><span class="p">,</span>
                        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">additional_formula_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_predicates</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span>
                                        <span class="s1">&#39;concept_model_root&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;concept_model_root&#39;</span><span class="p">]),</span>
                                        <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,},</span>
                                        <span class="n">_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
        <span class="n">formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">gt_formula_obj</span><span class="p">:</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_formula_obj</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">formula_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_formula_spec&#39;</span><span class="p">],</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_dict_trafo</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">SameSizeTensorValues</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicate_setts&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;same_size_mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">mod</span><span class="p">(</span><span class="n">formula_obj</span><span class="p">,</span> <span class="n">gt_formula_obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="p">(</span>
               <span class="n">additional_formula_mods</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_formulas</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;formula&#39;</span><span class="p">:</span> <span class="n">formula_obj</span><span class="p">,</span>
                                <span class="o">**</span><span class="p">({</span><span class="s1">&#39;gt_formula&#39;</span><span class="p">:</span> <span class="n">gt_formula_obj</span><span class="p">}</span> <span class="k">if</span> <span class="n">gt_formula_obj</span> <span class="k">else</span> <span class="p">{})}</span>
        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recalculating parts of the formula values.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original formula spec:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;formula_spec&#39;</span><span class="p">],</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original formula:&quot;</span><span class="p">,</span> <span class="n">formula_obj</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original gt_formula:&quot;</span><span class="p">,</span> <span class="n">gt_formula_obj</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Additionally calculated formula outputs:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Changed constants for formula evaluation:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed_constants</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recalc</span> <span class="o">==</span> <span class="s1">&#39;formula&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">final_cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_formulas</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">recalc</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">recalc</span> <span class="o">==</span> <span class="s2">&quot;always&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caches</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imgs_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">[</span><span class="s1">&#39;imgs_dir&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="ResultsIterator.from_cache"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.from_cache">[docs]</a>    <span class="k">def</span> <span class="nf">from_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
        <span class="n">img_t</span><span class="p">,</span> <span class="n">masks_t</span> <span class="o">=</span> <span class="n">load_orig_and_masks</span><span class="p">(</span>
            <span class="n">img_fn</span><span class="o">=</span><span class="n">img_fn</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">raise_on_missing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raise_on_missing</span><span class="p">,</span>
            <span class="n">orig_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">],</span>
            <span class="n">pedestrian_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pedestrian_key&#39;</span><span class="p">],</span> <span class="n">gt_pedestrian_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_pedestrian_key&#39;</span><span class="p">],</span>
            <span class="n">use_pretty_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># use correct concept names</span>
        <span class="n">masks_t</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;concept_pretty_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">v</span>
                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">masks_t</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="c1"># filter non-existing files</span>
        <span class="n">masks_t</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks_t</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">img_t</span><span class="p">,</span> <span class="n">masks_t</span></div>

<div class="viewcode-block" id="ResultsIterator.recalc_predicate_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.recalc_predicate_masks">[docs]</a>    <span class="k">def</span> <span class="nf">recalc_predicate_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">img_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_t</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img_t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mask_updates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">calc_helpers</span><span class="o">.</span><span class="n">cached_eval</span><span class="p">(</span><span class="n">input_batch</span><span class="o">=</span><span class="n">img_t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predicates</span><span class="p">,</span>
                                     <span class="n">descriptors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mask_updates</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

<div class="viewcode-block" id="ResultsIterator.recalc_formula_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.recalc_formula_masks">[docs]</a>    <span class="k">def</span> <span class="nf">recalc_formula_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masks_t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
                             <span class="n">recalc_formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span>
                             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">recalc_formula_masks</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">masks_t</span><span class="p">,</span>
            <span class="n">additional_formulas</span><span class="o">=</span><span class="n">recalc_formulas</span><span class="p">,</span>
            <span class="n">changed_constants</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">changed_constants</span><span class="p">,</span>
            <span class="n">masks_dict_trafo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_dict_trafo</span><span class="p">,</span>
            <span class="n">do_postfix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_broadcast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="ResultsIterator.get_all_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator.get_all_masks">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img_t</span><span class="p">,</span> <span class="n">masks_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span><span class="n">img_fn</span><span class="p">)</span>
            <span class="n">curr_recalc_formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">trafos</span><span class="o">.</span><span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">masks_t</span><span class="p">},</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_formulas</span><span class="p">}</span>
            <span class="c1"># recalc missing formula input masks</span>
            <span class="k">if</span> <span class="n">img_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="nb">any</span><span class="p">(</span><span class="n">masks_t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">form_obj</span> <span class="ow">in</span> <span class="n">curr_recalc_formulas</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">form_obj</span><span class="o">.</span><span class="n">all_in_keys</span><span class="p">):</span>
                <span class="n">masks_t</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recalc_predicate_masks</span><span class="p">(</span><span class="n">img_t</span><span class="p">))</span>
            <span class="c1"># recalc formula masks</span>
            <span class="n">masks_t</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recalc_formula_masks</span><span class="p">(</span><span class="n">masks_t</span><span class="p">,</span> <span class="n">curr_recalc_formulas</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pretty_names</span><span class="p">:</span>
                <span class="n">masks_t</span> <span class="o">=</span> <span class="p">{</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">masks_t</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error during processing image file </span><span class="si">{}</span><span class="s2"> for experiment </span><span class="si">{}</span><span class="s2">&quot;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sacred_logdir&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">img_t</span><span class="p">,</span> <span class="n">masks_t</span></div></div>


<div class="viewcode-block" id="to_logic_dirs"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_logic_dirs.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_logic_dirs">[docs]</a><span class="k">def</span> <span class="nf">to_logic_dirs</span><span class="p">(</span><span class="n">experiment_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">formula_dirs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">skip_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Get the sub-directories for logic experiments based on given information.</span>

<span class="sd">    :param formula_dirs: list of (full) directories to include; by default excluded are &quot;.*&quot;, &quot;_*&quot;, &quot;*results_cache&quot;</span>
<span class="sd">    :param model_key: key and directory name of the model </span>
<span class="sd">    :return: list of logic dirs (full paths)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logic_type</span> <span class="o">=</span> <span class="n">logic_type</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="n">exp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_root</span><span class="p">,</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">skip_missing</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping missing experiment dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Experiment dir </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">))</span>

    <span class="n">formula_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">f_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f_dir</span> <span class="ow">in</span> <span class="n">formula_dirs</span><span class="p">]</span> <span class="k">if</span> <span class="n">formula_dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
        <span class="p">[</span><span class="n">f_dir</span> <span class="k">for</span> <span class="n">f_dir</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">)]</span>
         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f_dir</span><span class="p">)</span>
         <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f_dir</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
         <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f_dir</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
         <span class="ow">and</span> <span class="ow">not</span> <span class="n">f_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;results_cache&quot;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">f_dir</span> <span class="ow">in</span> <span class="n">formula_dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">skip_missing</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping missing formula dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_dir</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Formula dir </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_dir</span><span class="p">))</span>
    <span class="n">logic_dirs_by_fdir</span> <span class="o">=</span> <span class="p">{</span><span class="n">f_dir</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f_dir</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span>
        <span class="n">f_dir</span><span class="p">)]</span> <span class="k">for</span> <span class="n">f_dir</span> <span class="ow">in</span> <span class="n">formula_dirs</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f_dir</span><span class="p">)}</span>
    <span class="n">logic_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ldir</span> <span class="k">for</span> <span class="n">ldirs</span> <span class="ow">in</span> <span class="n">logic_dirs_by_fdir</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">ldir</span> <span class="ow">in</span> <span class="n">ldirs</span> <span class="k">if</span> <span class="n">logic_type</span> <span class="ow">in</span> <span class="n">ldir</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">logic_dirs</span></div>


<span class="c1"># =====================</span>
<span class="c1"># EXPERIMENT LOADING</span>
<span class="c1"># =====================</span>

<div class="viewcode-block" id="get_metrics"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.get_metrics.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.get_metrics">[docs]</a><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="n">experiment_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">formula_dirs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skip_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Given a sacred ``experiment_root``, collect all experiment settings and results for the respective filters.</span>
<span class="sd">    Filters: model, formula(s), logic type.</span>
<span class="sd">    Experiment settings: formula formulation (``formula_dirs``), predicate settings, constant values.</span>
<span class="sd">    Metrics: all result metrics saved by the respective formula verification experiment.</span>

<span class="sd">    :param skip_missing: if unset, raise in case no metrics subdirectory can be found for a matching experiment dir</span>
<span class="sd">    :return: list of dictionaries, each entry corresponding to a single experiment (filter/settings &amp; results);</span>
<span class="sd">        can directly be used to create a ``pd.DataFrame``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logic_dirs</span> <span class="o">=</span> <span class="n">to_logic_dirs</span><span class="p">(</span><span class="n">experiment_root</span><span class="o">=</span><span class="n">experiment_root</span><span class="p">,</span> <span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                               <span class="n">formula_dirs</span><span class="o">=</span><span class="n">formula_dirs</span><span class="p">,</span> <span class="n">logic_type</span><span class="o">=</span><span class="n">logic_type</span><span class="p">,</span> <span class="n">skip_missing</span><span class="o">=</span><span class="n">skip_missing</span><span class="p">)</span>
    <span class="c1"># Collect infos &amp; plot visualizations</span>
    <span class="n">all_infos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">logic_dir</span> <span class="ow">in</span> <span class="n">logic_dirs</span><span class="p">:</span>
        <span class="n">curr_infos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">logic_dir</span><span class="o">=</span><span class="n">logic_dir</span><span class="p">)</span>

        <span class="c1"># METRICS</span>
        <span class="n">sacred_logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
        <span class="n">metrics_logdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mdir</span> <span class="k">for</span> <span class="n">mdir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">mdir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">)]</span>
        <span class="n">empty_metrics_logdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mdir</span> <span class="k">for</span> <span class="n">mdir</span> <span class="ow">in</span> <span class="n">metrics_logdirs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">mdir</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">non_empty_metrics_logdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mdir</span> <span class="k">for</span> <span class="n">mdir</span> <span class="ow">in</span> <span class="n">metrics_logdirs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">mdir</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Some sanity checks regarding folder structure</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_metrics_logdirs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> empty metrics logdir entries (failed or running experiments?) in logdir </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_metrics_logdirs</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">),</span>
                                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">empty_metrics_logdirs</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_empty_metrics_logdirs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found metrics logdir with </span><span class="si">{}</span><span class="s2"> non-empty entries (several succeeded experiments?):</span><span class="se">\n</span><span class="s2">logdir: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">entries: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">metrics_logdirs</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">),</span> <span class="n">metrics_logdirs</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_empty_metrics_logdirs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No non-empty metrics logdir found in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping metrics logdir (no non-empty subdirs found) </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">)))</span>
                <span class="k">continue</span>

        <span class="n">metrics_logdir</span> <span class="o">=</span> <span class="n">non_empty_metrics_logdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metrics_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">metrics_logdir</span><span class="p">,</span> <span class="s2">&quot;metrics.csv&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">)</span> <span class="ow">and</span> <span class="n">skip_missing</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping missing file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
        <span class="n">curr_infos</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># FORMULA SPECS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">get_exp_conf</span><span class="p">(</span><span class="n">sacred_logdir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skip_missing</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Skipping logic dir </span><span class="si">%s</span><span class="s2"> due to error during configuration loading:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">logic_dir</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">formula_obj</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">formula_to_display_name</span><span class="p">(</span>
            <span class="n">formula_obj</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span> <span class="n">max_len</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">curr_infos</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="n">gt_formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;gt_formula_spec&#39;</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span>
            <span class="n">gt_formula_obj</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">get_formula_obj</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">formula_spec</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_formula_spec&#39;</span><span class="p">])</span>
            <span class="n">gt_formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">gt_formula_obj</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span> <span class="n">max_len</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">curr_infos</span><span class="p">[</span><span class="s1">&#39;gt_formula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gt_formula</span>

        <span class="c1"># CONSTANTS</span>
        <span class="n">curr_infos</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">])</span>

        <span class="c1"># PREDICATE SETTINGS</span>
        <span class="n">predicate_setts</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;predicate_setts&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ispartofa&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ispartofa_setts&#39;</span><span class="p">,</span> <span class="p">{})})</span>
        <span class="n">curr_infos</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;predicate_setts.</span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">pred</span><span class="p">,</span>
                          <span class="n">setts</span> <span class="ow">in</span> <span class="n">predicate_setts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">setts</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="n">all_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_infos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_infos</span></div>


<div class="viewcode-block" id="gather_results"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_results.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_results">[docs]</a><span class="k">def</span> <span class="nf">gather_results</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">get_metrics_args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Gather and cache DataFrame containing experiment metric results.</span>
<span class="sd">    Convenience shortcut for calling :py:func:`get_metrics`, standard post-processing, and CSV caching.</span>

<span class="sd">    :param metrics_csv: where to load/save metric results from/to</span>
<span class="sd">    :param get_metrics_args: see :py:func:`get_metrics`</span>
<span class="sd">    :return: DataFrame with columns for all experiment settings and metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_metrics_args_defaults</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">model_key</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;maskrcnn_box&quot;</span><span class="p">,</span> <span class="s2">&quot;tf_efficientdet_d1&quot;</span><span class="p">],</span>
        <span class="n">split</span><span class="o">=</span><span class="s2">&quot;TEST&quot;</span><span class="p">,</span>
        <span class="n">logic_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boolean&quot;</span><span class="p">,</span> <span class="s2">&quot;lukasiewicz&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="s2">&quot;goedel&quot;</span><span class="p">],)</span>
    <span class="k">if</span> <span class="n">metrics_csv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">do_for</span><span class="p">(</span>
            <span class="n">get_metrics</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">get_metrics_args_defaults</span><span class="p">,</span>
               <span class="o">**</span><span class="n">get_metrics_args</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">metrics_flat</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="o">**</span><span class="n">setts</span><span class="p">,</span> <span class="o">**</span><span class="n">metr_info</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">setts</span><span class="p">,</span> <span class="n">formula_metr</span> <span class="ow">in</span> <span class="n">metrics</span>
            <span class="k">for</span> <span class="n">metr_info</span> <span class="ow">in</span> <span class="n">formula_metr</span>
        <span class="p">]</span>
        <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">add_cols_to_metrics_pd</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics_flat</span><span class="p">))</span>
        <span class="c1"># Filter out the Boolean dot at mask_thresh==0.5:</span>
        <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">metrics_pd</span><span class="o">.</span><span class="n">formula_attrs</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
            <span class="s1">&#39;(Boolean)&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metrics_pd</span><span class="o">.</span><span class="n">logic_type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">))]</span>
        <span class="c1"># Cache results:</span>
        <span class="k">if</span> <span class="n">metrics_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">metrics_pd</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">metrics_csv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics_pd</span></div>


<div class="viewcode-block" id="gather_aucs"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_aucs.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_aucs">[docs]</a><span class="k">def</span> <span class="nf">gather_aucs</span><span class="p">(</span>
    <span class="n">metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">other_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;img_mon_thresh&#39;</span><span class="p">,</span>
    <span class="n">formulas</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;formula with S-implies, (Boolean)&#39;</span><span class="p">,</span> <span class="s1">&#39;formula with S-implies&#39;</span><span class="p">,</span>
              <span class="s1">&#39;formula with S-implies, calibrated, (Boolean)&#39;</span><span class="p">,</span> <span class="s1">&#39;formula with S-implies, calibrated&#39;</span><span class="p">),</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">aucs_for_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Gather area under curve values for several formulas.</span>
<span class="sd">    See :py:func:`aucs_for` for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span> <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{</span>
        <span class="s1">&#39;predicate_setts.AllNeighbors.kernel_size&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span>
        <span class="s1">&#39;predicate_setts.GTAllNeighbors.kernel_size&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;gt_</span><span class="si">{</span><span class="n">other_by</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">constrained_metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">constrain_pd</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="n">aucs</span> <span class="o">=</span> <span class="n">do_for</span><span class="p">(</span>
        <span class="n">auc_for</span><span class="p">,</span> <span class="n">allow_looping</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;model_key&#39;</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">),</span> <span class="n">verbose_looping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">metrics_pd</span><span class="o">=</span><span class="n">constrained_metrics_pd</span><span class="p">,</span>
        <span class="n">other_by</span><span class="o">=</span><span class="n">other_by</span><span class="p">,</span>
        <span class="n">model_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;maskrcnn_box&#39;</span><span class="p">,</span> <span class="s1">&#39;tf_efficientdet_d1&#39;</span><span class="p">],</span>
        <span class="n">logic_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;goedel&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;lukasiewicz&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                    <span class="p">],</span>
        <span class="n">formula</span><span class="o">=</span><span class="n">formulas</span><span class="p">,</span>
        <span class="o">**</span><span class="n">aucs_for_kwargs</span>
    <span class="p">)</span>
    <span class="n">aucs_flat</span> <span class="o">=</span> <span class="p">[{</span><span class="o">**</span><span class="n">setts</span><span class="p">,</span> <span class="o">**</span><span class="n">auc</span><span class="p">}</span> <span class="k">for</span> <span class="n">setts</span><span class="p">,</span> <span class="n">auc</span> <span class="ow">in</span> <span class="n">aucs</span><span class="p">]</span>
    <span class="n">aucs_pd</span> <span class="o">=</span> <span class="n">add_cols_to_metrics_pd</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aucs_flat</span><span class="p">))</span>
    <span class="n">aucs_pd</span> <span class="o">=</span> <span class="p">(</span><span class="n">aucs_pd</span><span class="p">[</span><span class="n">aucs_pd</span><span class="o">.</span><span class="n">num_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">({</span><span class="o">*</span><span class="n">aucs_for_kwargs</span><span class="p">,</span> <span class="s1">&#39;other_by&#39;</span><span class="p">,</span> <span class="s1">&#39;other_at&#39;</span><span class="p">,</span> <span class="s1">&#39;implies&#39;</span><span class="p">,</span> <span class="s1">&#39;CloseBy&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;denoised&#39;</span><span class="p">,</span> <span class="s1">&#39;Boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;formula_attrs&#39;</span><span class="p">}</span>
                              <span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">aucs_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;metrics_pd&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;model_key&#39;</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">aucs_pd</span></div>


<span class="c1"># ================================</span>
<span class="c1"># EXPERIMENT POST-EVALUATION</span>
<span class="c1"># ================================</span>

<div class="viewcode-block" id="recalc_formula_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.recalc_formula_masks.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.recalc_formula_masks">[docs]</a><span class="k">def</span> <span class="nf">recalc_formula_masks</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">masks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
                         <span class="n">additional_formulas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span>
                         <span class="n">changed_constants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">masks_dict_trafo</span><span class="p">:</span> <span class="n">trafos</span><span class="o">.</span><span class="n">Transform</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">do_postfix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do_broadcast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Given a sacred experiment ``conf``ig, changes to constants, and predicate ``masks``,</span>
<span class="sd">    calculate the values of the given ``additional_formulas``.</span>

<span class="sd">    :param mask_dict_trafo: transformation applied to the dictionary of torch tensor input masks</span>
<span class="sd">        before feeding them to the ``additional_formulas``;</span>
<span class="sd">        defaults to the default one according to the experiment</span>
<span class="sd">    :param changed_constants: mapping of constant key to new value</span>
<span class="sd">    :return: dictionary of torch tensor masks from ``masks``, and the newly calculated ones</span>
<span class="sd">        using the keys from ``additional_formulas``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_formulas</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">masks_dict_trafo</span> <span class="o">=</span> <span class="n">masks_dict_trafo</span> <span class="ow">or</span> <span class="n">trafos</span><span class="o">.</span><span class="n">SameSizeTensorValues</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicate_setts&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;same_size_mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">changed_constants</span> <span class="o">=</span> <span class="n">changed_constants</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">mask</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">]])</span>
             <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">postfix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;_lp&#39;</span> <span class="k">if</span> <span class="n">do_postfix</span> <span class="ow">and</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;concept_model_args&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;use_laplace&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">all_masks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pedestrian_key&#39;</span><span class="p">]:</span> <span class="n">masks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pedestrian_key&#39;</span><span class="p">]),</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_pedestrian_key&#39;</span><span class="p">]:</span> <span class="n">masks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_pedestrian_key&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">+</span><span class="n">postfix</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)}}</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">masks_dict_trafo</span><span class="p">(</span><span class="n">all_masks</span><span class="p">),</span>
           <span class="o">**</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">],</span>
           <span class="o">**</span><span class="n">changed_constants</span><span class="p">}</span>

    <span class="n">calced_masks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">form</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">additional_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">calced</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span> <span class="o">=</span> <span class="n">form</span><span class="p">(</span><span class="n">inp</span><span class="p">)[</span><span class="n">form</span><span class="o">.</span><span class="n">out_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">calced</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Any input mask missing?</span>
            <span class="k">continue</span>
        <span class="n">calced</span> <span class="o">=</span> <span class="n">calced</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calced</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">do_broadcast</span> \
            <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">calced</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">]])</span>
        <span class="n">calced_masks</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">calced</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">calced_masks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">additional_formulas</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)}</span></div>


<div class="viewcode-block" id="gather_exp_stats"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_exp_stats.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_exp_stats">[docs]</a><span class="k">def</span> <span class="nf">gather_exp_stats</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">iterator</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]],</span>
                     <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">force_reevaluate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a DataFrame summary of statistics of the masks created during a fuzzy logic experiment.</span>
<span class="sd">    The dataframe will feature</span>

<span class="sd">    - rows: indexed by image file names</span>
<span class="sd">    - columns: indexed by double index of ``(mask_type, value_type)``;</span>
<span class="sd">      ``mask_type``s: formula, ped, [gt, ] &lt;concepts&gt;;</span>
<span class="sd">      ``value_type``s: stddev, max, min, num_entries,</span>
<span class="sd">      num_interesting, mean_interesting, stddev_interesting,</span>
<span class="sd">      mean_formula_non_one, stddev_formula_non_one,</span>
<span class="sd">      mean_ped_non_zero, stddev_ped_non_zero,</span>
<span class="sd">      mean_concepts_non_zero, stddev_concepts_non_zero;</span>
<span class="sd">      ``*_interesting`` / ``*_ped_non_zero`` / ``*_concepts_non_zero``</span>
<span class="sd">      means values after application of masks where the</span>
<span class="sd">      formula mask is below ``1-thresh``/ person mask above ``thresh`` / all concept masks above ``thresh``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_reevaluate</span> <span class="ow">and</span> <span class="n">save_as</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_as</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">save_as</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Masks processed&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="n">masks_trafo</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">])</span>

        <span class="n">formula</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">)</span>
        <span class="n">ped</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pedestrian_key&#39;</span><span class="p">]))</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">formula_to_display_name</span><span class="p">(</span>
            <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;gt_pedestrian_key&#39;</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;gt_pedestrian_key&#39;</span> <span class="ow">in</span> <span class="n">conf</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">concepts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">masks</span>

        <span class="c1"># binary masks for interesting values</span>
        <span class="n">formula_non_one</span> <span class="o">=</span> <span class="n">formula</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">thresh</span><span class="p">)</span>
        <span class="n">ped_non_zero</span> <span class="o">=</span> <span class="n">ped</span> <span class="o">&gt;</span> <span class="n">thresh</span>
        <span class="n">concepts_non_zeros</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">c</span><span class="p">:</span> <span class="n">tens</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">tens</span> <span class="ow">in</span> <span class="n">concepts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>  <span class="c1"># original size</span>
        <span class="n">concepts_non_zero</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">masks_trafo</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">float</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
                                                                     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">concepts_non_zeros</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="c1"># Add ground-truth, false positive and false negative info if available:</span>
        <span class="n">gt_masks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">gt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gt_non_zero</span> <span class="o">=</span> <span class="p">(</span><span class="n">gt</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span>
            <span class="n">fpos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">gt_non_zero</span><span class="p">,</span> <span class="n">ped</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ped</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">ped</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>    <span class="c1"># ~gt &amp; ped</span>
            <span class="n">fpos_non_zero</span> <span class="o">=</span> <span class="n">fpos</span> <span class="o">&gt;</span> <span class="n">thresh</span>
            <span class="n">fneg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gt_non_zero</span><span class="p">,</span> <span class="mf">1.</span><span class="o">-</span><span class="n">ped</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="n">ped</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">ped</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>  <span class="c1"># gt &amp; ~ped</span>
            <span class="n">fneg_non_zero</span> <span class="o">=</span> <span class="n">fneg</span> <span class="o">&gt;</span> <span class="n">thresh</span>
            <span class="n">gt_masks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">gt_non_zero</span><span class="p">),</span> <span class="n">fpos</span><span class="o">=</span><span class="p">(</span>
                <span class="n">fpos</span><span class="p">,</span> <span class="n">fpos_non_zero</span><span class="p">),</span> <span class="n">fneg</span><span class="o">=</span><span class="p">(</span><span class="n">fneg</span><span class="p">,</span> <span class="n">fneg_non_zero</span><span class="p">))</span>

        <span class="c1"># actual data summary</span>
        <span class="n">data</span><span class="p">[</span><span class="n">img_fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_interesting</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">formula_non_one</span><span class="p">),</span>
                                                    <span class="n">ped</span><span class="o">=</span><span class="p">(</span><span class="n">ped</span><span class="p">,</span> <span class="n">ped_non_zero</span><span class="p">),</span>
                                                    <span class="o">**</span><span class="n">gt_masks</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">(</span><span class="n">concepts</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">concepts_non_zeros</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">},)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span><span class="p">[</span><span class="n">img_fn</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;stddev&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)],</span> <span class="n">torch</span><span class="o">.</span><span class="n">std_mean</span><span class="p">(</span><span class="n">mask</span><span class="p">))),</span>  <span class="c1"># mean + stddev per image</span>
                <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">):</span> <span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>  <span class="c1"># maximum pixel value</span>
                <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">):</span> <span class="n">mask</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>  <span class="c1"># minimum pixel value</span>
                <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;num_entries&#39;</span><span class="p">):</span> <span class="n">mask</span><span class="o">.</span><span class="n">numel</span><span class="p">(),</span>  <span class="c1"># num entries in mask</span>
                <span class="c1"># num interesting entries in mask</span>
                <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;num_interesting&#39;</span><span class="p">):</span> <span class="n">mask_interesting</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;stddev_interesting&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;mean_interesting&#39;</span><span class="p">)],</span>
                           <span class="n">torch</span><span class="o">.</span><span class="n">std_mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_interesting</span><span class="p">)))),</span>  <span class="c1"># mean + stddev per image (only for interesting entries)</span>
                <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;stddev_formula_non_one&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;mean_formula_non_one&#39;</span><span class="p">)],</span>
                           <span class="n">torch</span><span class="o">.</span><span class="n">std_mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">masks_trafo</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">formula_non_one</span><span class="p">)))),</span>  <span class="c1"># mean + stddev per image (only non-1-entries of formula)</span>
                <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;stddev_ped_non_zero&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;mean_ped_non_zero&#39;</span><span class="p">)],</span>
                           <span class="n">torch</span><span class="o">.</span><span class="n">std_mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">masks_trafo</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">ped_non_zero</span><span class="p">)))),</span>  <span class="c1"># mean + stddev per image (only non-0-entries of pedestrian)</span>
                <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;stddev_concepts_non_zero&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;mean_concepts_non_zero&#39;</span><span class="p">)],</span>
                           <span class="n">torch</span><span class="o">.</span><span class="n">std_mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">masks_trafo</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">concepts_non_zero</span><span class="p">)))),</span>  <span class="c1"># mean + stddev per image (only non-0-entries of any concept mask)</span>
            <span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">img_fn</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">tens</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tens</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">tens</span>
                                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">tens</span> <span class="ow">in</span> <span class="n">img_data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">img_fn</span><span class="p">,</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
    <span class="c1"># Mean number of interesting pixels</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">df</span><span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;proportion_interesting&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;num_interesting&#39;</span><span class="p">)]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;num_entries&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_as</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_as</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="summarize_exp_stats"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.summarize_exp_stats.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.summarize_exp_stats">[docs]</a><span class="k">def</span> <span class="nf">summarize_exp_stats</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Gather mean, std, min, max for the experiment stats DataFrame into</span>
<span class="sd">    a summary DataFrame (with these columns).</span>

<span class="sd">    :param df: DataFrame of the format provided by ``gather_exp_stats``</span>
<span class="sd">    :return: DataFrame with</span>

<span class="sd">        - column indices:</span>
<span class="sd">          level 1: ``proportion_interesting``, ``mean``, ``stddev``, ``mean_interesting``, ``stddev_interesting``;</span>
<span class="sd">          level 2: ``mean``, ``std``, ``max``, ``min``</span>
<span class="sd">        - row indices: mask types</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;proportion_interesting&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;stddev&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mean_interesting&#39;</span><span class="p">,</span> <span class="s1">&#39;stddev_interesting&#39;</span><span class="p">]</span>

    <span class="c1"># Mean and standard deviation per column:</span>
    <span class="n">summaries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># .style.set_caption(&quot;Mean values per col.&quot;)</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># .style.set_caption(&quot;Global standard deviation values per col.&quot;))</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Minimum and maximum per column:</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">summaries_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">summaries_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summaries_df</span></div>


<div class="viewcode-block" id="auc_for"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.auc_for.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.auc_for">[docs]</a><span class="k">def</span> <span class="nf">auc_for</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formula_name_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;formula_attrs&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;false_positive_rate&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span>
            <span class="n">other_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;f1score&#39;</span><span class="p">:</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="s1">&#39;recall&#39;</span><span class="p">},</span>
            <span class="n">other_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;img_mon_thresh&#39;</span><span class="p">,</span>
            <span class="n">other_at</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
            <span class="n">precision</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Collect area under curve of x-y-plots for the given experiment series.</span>
<span class="sd">    The output dictionary may contain further values at specific points on the curve.</span>
<span class="sd">    Precisely, values of the ``other_metrics`` are collected at the values ``other_at`` of the setting ``other_by``</span>
<span class="sd">    (by default: F1 score, precision and recall at values 0.1, 0.5 and 0.9 of the threshold ``img_mon_thresh``).</span>

<span class="sd">    :param metrics_pd: DataFrame with metric results (see :py:func:`get_metrics`)</span>
<span class="sd">    :param model_key: the model key and directory name</span>
<span class="sd">    :param logic_type: the logic type</span>
<span class="sd">    :param formula: the formula specifier</span>
<span class="sd">    :param x: column with x-values in the x-y-plot</span>
<span class="sd">    :param y: column with y-values in the x-y-plot</span>
<span class="sd">    :param other_metrics: dictionary where keys are column names of other metrics to sample points values from,</span>
<span class="sd">        dict values are pretty names thereof to use as keys in the output dict</span>
<span class="sd">    :param formula_name_col: column with values to match with ``formula``</span>
<span class="sd">    :param precision: number display precision used to create keys for the ``other_metrics`` values in the output dict</span>
<span class="sd">    :return: dictionary of the form ``{&#39;auc&#39;: float, &#39;num_points&#39;: int, &#39;&lt;other_metric&gt;@&lt;other_by_value&gt;&#39;: float}``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model_key&#39;</span><span class="p">:</span> <span class="n">model_key</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">:</span> <span class="n">logic_type</span><span class="p">,</span> <span class="n">formula_name_col</span><span class="p">:</span> <span class="n">formula</span><span class="p">}</span>
    <span class="n">constrained_metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">constrain_pd</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="n">xy</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">constrained_metrics_pd</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]]</span>\
        <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>\
        <span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
    <span class="n">other_vals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">m_pretty</span> <span class="ow">in</span> <span class="n">other_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">other_at</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">constrained_metrics_pd</span><span class="p">[</span><span class="n">constrained_metrics_pd</span><span class="p">[</span><span class="n">other_by</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">)</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{m_pretty}</span><span class="s1">@{t:.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;f}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m_pretty</span><span class="o">=</span><span class="n">m_pretty</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                <span class="n">other_vals</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">other_vals</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;WARNING: NaN metrics value for: </span><span class="si">{</span><span class="n">curr</span><span class="o">.</span><span class="n">experiment_root</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">model_key</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">logic_type</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">formula</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">t</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">m</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">other_vals</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># {curr.to_dict()=}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="n">y</span><span class="p">]),</span> <span class="s1">&#39;num_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span>
            <span class="c1"># &#39;max_f1&#39;: constrained_metrics_pd[&#39;f1score&#39;].astype(float).max(),</span>
            <span class="c1"># &#39;max_f1_thresh&#39;: constrained_metrics_pd.loc[constrained_metrics_pd[&#39;f1score&#39;].astype(float).idxmax(), other_by],</span>
            <span class="o">**</span><span class="n">other_vals</span><span class="p">,</span>
            <span class="p">}</span></div>


<div class="viewcode-block" id="to_formula_attrs"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_formula_attrs.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_formula_attrs">[docs]</a><span class="k">def</span> <span class="nf">to_formula_attrs</span><span class="p">(</span><span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Extract key properties from the formula string.</span>
<span class="sd">    Format: {</span>
<span class="sd">    &#39;implies&#39;: Literal[&#39;R&#39;,&#39;S&#39;],</span>
<span class="sd">    &#39;CloseBy&#39;: Literal[&#39;CoveredBy&#39;, &#39;downscaled&#39;],</span>
<span class="sd">    &#39;calibrated&#39;: bool, &#39;denoised&#39;: bool, &#39;Boolean&#39;: bool</span>
<span class="sd">    }&quot;&quot;&quot;</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;implies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span> <span class="k">if</span> <span class="s1">&#39;&gt;&gt;&#39;</span> <span class="ow">in</span> <span class="n">formula</span> <span class="ow">or</span> <span class="s1">&#39;&lt;&lt;&#39;</span> <span class="ow">in</span> <span class="n">formula</span> <span class="k">else</span> <span class="s1">&#39;S&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;IsPartOfA&#39;</span> <span class="ow">in</span> <span class="n">formula</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;CloseBy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CoveredBy&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;_down&#39;</span> <span class="ow">in</span> <span class="n">formula</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;CloseBy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;downscaled&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;CloseBy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;calibrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_lp&#39;</span> <span class="ow">in</span> <span class="n">formula</span><span class="p">)</span>
    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;denoised&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;((ankle_lp||arm_lp||eye_lp||leg_lp||wrist_lp)&gt;=mask_thresh)&amp;&amp;(ankle_lp||arm_lp||eye_lp||leg_lp||wrist_lp)&#39;</span> <span class="ow">in</span> <span class="n">formula</span>
                         <span class="ow">or</span> <span class="s1">&#39;((ankle||arm||eye||leg||wrist)&gt;=mask_thresh)&amp;&amp;(ankle||arm||eye||leg||wrist))&#39;</span> <span class="ow">in</span> <span class="n">formula</span><span class="p">)</span>
    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Boolean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;bool_thresh&#39;</span> <span class="ow">in</span> <span class="n">formula</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attrs</span></div>


<div class="viewcode-block" id="to_formula_attrs_str"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_formula_attrs_str.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_formula_attrs_str">[docs]</a><span class="k">def</span> <span class="nf">to_formula_attrs_str</span><span class="p">(</span><span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Turn formula in nice short string listing its attributes.&quot;&quot;&quot;</span>
    <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_formula_attrs</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;implies&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-implies&#39;</span><span class="p">)</span>
    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;CloseBy&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;CloseBy&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;calibrated&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;calibrated&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;denoised&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;denoised&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(Boolean)&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Boolean&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="s1">&#39;formula&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39; with </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_cols_to_metrics_pd"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.add_cols_to_metrics_pd.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.add_cols_to_metrics_pd">[docs]</a><span class="k">def</span> <span class="nf">add_cols_to_metrics_pd</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add some standard aliases and derived values to outputs of ``get_metrics``.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">cols</span><span class="p">():</span> <span class="k">return</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="c1"># Fix types:</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="c1"># &#39;all_min&#39;, &#39;exists_max&#39;, # bools that got parsed to string :-/</span>
            <span class="s1">&#39;all_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;all_mean_gt&#39;</span><span class="p">,</span> <span class="s1">&#39;all_binary_mean@050&#39;</span><span class="p">,</span>
            <span class="s1">&#39;std_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1score&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span>
            <span class="s1">&#39;negpredictiveval&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;thresh&#39;</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">or</span> <span class="s1">&#39;rate&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
       <span class="p">]},</span> <span class="o">**</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
           <span class="o">*</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;kernel_size&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
       <span class="p">]},</span>
    <span class="p">}</span>
    <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">dtype</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>

    <span class="c1"># TPR</span>
    <span class="k">if</span> <span class="s1">&#39;true_positive_rate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;recall&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;true_positive_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># TNR</span>
    <span class="k">if</span> <span class="s1">&#39;true_negative_rate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;specificity&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;true_negative_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;specificity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;true_negative_rate&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;specificity&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;true_negative_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;true_negative_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;specificity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    <span class="c1"># FPR</span>
    <span class="k">if</span> <span class="s1">&#39;false_positive_rate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;true_negative_rate&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;false_positive_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> \
            <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;true_negative_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;false_positive_rate&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;true_negative_rate&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;false_positive_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;false_positive_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;true_negative_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    <span class="c1"># monitor threshold</span>
    <span class="k">if</span> <span class="s1">&#39;mon_thresh&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;monitor_thresh&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;mon_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> \
            <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;monitor_thresh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;mon_thresh&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;monitor_thresh&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;mon_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;mon_thresh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;monitor_thresh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    <span class="c1"># same_size_mode</span>
    <span class="k">if</span> <span class="s1">&#39;same_size_mode&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;same_size_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;same_size_mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;up_bilinear&#39;</span><span class="p">)</span>
    <span class="c1"># nice formula names</span>
    <span class="n">additional_formula_names</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">to_formula_attrs</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
    <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">additional_formula_names</span><span class="p">[[</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">additional_formula_names</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
    <span class="k">if</span> <span class="s1">&#39;formula_attrs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;formula&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;formula_attrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">to_formula_attrs_str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;gt_formula_attrs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;gt_formula&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">():</span>
        <span class="n">metrics_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;gt_formula_attrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="s1">&#39;gt_formula&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">to_formula_attrs_str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">metrics_pd</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Continental Automotive GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>