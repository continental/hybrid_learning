<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis &mdash; hybrid_learning  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/autoclasstoc.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> hybrid_learning
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../userguide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apiref/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">How to contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">hybrid_learning</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright (c) 2022 Continental Automotive GmbH</span>
<span class="sd">&quot;&quot;&quot;Helper functions for visualization of fuzzy logic experiment results.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="kn">from</span> <span class="nn">hybrid_learning.datasets</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">trafos</span><span class="p">,</span> <span class="n">data_visualization</span>
<span class="kn">from</span> <span class="nn">hybrid_learning</span> <span class="kn">import</span> <span class="n">fuzzy_logic</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.datasets.transforms.common</span> <span class="kn">import</span> <span class="n">lazy_format</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.experimentation.exp_eval_common</span> <span class="kn">import</span> <span class="n">show_and_save_plot</span><span class="p">,</span> <span class="n">constrain_pd</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.experimentation.fuzzy_exp</span> <span class="kn">import</span> <span class="n">fuzzy_exp_helpers</span> <span class="k">as</span> <span class="n">calc_helpers</span>
<span class="kn">from</span> <span class="nn">hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval</span> <span class="kn">import</span> <span class="n">to_logic_dirs</span><span class="p">,</span> <span class="n">get_exp_conf</span><span class="p">,</span> <span class="n">ResultsIterator</span><span class="p">,</span> \
    <span class="n">gather_exp_stats</span><span class="p">,</span> <span class="n">summarize_exp_stats</span><span class="p">,</span> <span class="n">formula_to_display_name</span><span class="p">,</span> <span class="n">to_tens</span><span class="p">,</span> <span class="n">display</span>

<span class="n">to_img</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">to_pil_image</span>


<div class="viewcode-block" id="summarize_plot_visualize_exp"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.summarize_plot_visualize_exp.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.summarize_plot_visualize_exp">[docs]</a><span class="k">def</span> <span class="nf">summarize_plot_visualize_exp</span><span class="p">(</span>
    <span class="n">experiment_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formula_dirs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># file path relative to logic_dir/metrics</span>
    <span class="n">per_image_stats_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;per_image_stats.csv&quot;</span><span class="p">,</span>
    <span class="n">force_reevaluate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">visualize</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="s1">&#39;worst&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># (&#39;worst&#39;, &#39;best&#39;),</span>
    <span class="n">num_interesting_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">only_filenames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Concatenation of per image stats gathering, stats summary, and optional visualization of formula body masks.</span>
<span class="sd">    Summary of</span>
<span class="sd">    :py:func:`hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_exp_stats`,</span>
<span class="sd">    :py:func:`hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.summarize_exp_stats`,</span>
<span class="sd">    :py:func:`plot_summaries`, and</span>
<span class="sd">    :py:func:`visualize_most_interesting_samples` with option to loop over several formulas.</span>
<span class="sd">    Formula body values are reevaluated.</span>

<span class="sd">    :param per_image_stats_csv: file path to a CSV file for caching the per image statistics</span>
<span class="sd">        (will contain information for one image per row);</span>
<span class="sd">        file path relative to the respective ``logic_type/metrics`` results directory</span>
<span class="sd">    :param visualize: list of different arguments for key ``best`` in :py:func:`visualize_most_interesting_samples`;</span>
<span class="sd">        set to ``None`` or an empty sequence to disable visualization of example images</span>
<span class="sd">    :param num_interesting_samples: see :py:func:`visualize_most_interesting_samples`</span>
<span class="sd">    :param force_reevaluate: see :py:func:`hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.gather_exp_stats`</span>
<span class="sd">    :param only_filenames: only take into account the files with given names in analysis and visualization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iterator_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="c1"># apply analytics to formula body</span>
                         <span class="n">additional_formula_mods</span><span class="o">=</span><span class="p">{</span>
                             <span class="s1">&#39;formula&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">in_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">in_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only_filenames</span><span class="p">:</span>
        <span class="n">iterator_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">only_filenames</span><span class="o">=</span><span class="n">only_filenames</span><span class="p">)</span>

    <span class="c1"># Derived config</span>
    <span class="n">logic_dirs</span> <span class="o">=</span> <span class="n">to_logic_dirs</span><span class="p">(</span><span class="n">experiment_root</span><span class="o">=</span><span class="n">experiment_root</span><span class="p">,</span> <span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                               <span class="n">formula_dirs</span><span class="o">=</span><span class="n">formula_dirs</span><span class="p">,</span> <span class="n">logic_type</span><span class="o">=</span><span class="n">logic_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logic_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not find any logic results directory for setting: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">experiment_root</span><span class="o">=</span><span class="n">experiment_root</span><span class="p">,</span> <span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                 <span class="n">formula_dirs</span><span class="o">=</span><span class="n">formula_dirs</span><span class="p">,</span> <span class="n">logic_type</span><span class="o">=</span><span class="n">logic_type</span><span class="p">)))</span>

    <span class="c1"># Collect infos &amp; plot visualizations</span>
    <span class="n">all_summaries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">logic_dir</span> <span class="ow">in</span> <span class="n">logic_dirs</span><span class="p">:</span>
        <span class="n">formula_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">)</span>
        <span class="n">summary_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">per_image_stats_csv</span><span class="p">)</span> <span class="k">if</span> <span class="n">per_image_stats_csv</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">get_exp_conf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">),</span> <span class="n">conf_validation_vals</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">))</span>
            <span class="c1"># use the continuous formula outout</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">ResultsIterator</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">load_images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">iterator_args</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">gather_exp_stats</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                                  <span class="n">save_as</span><span class="o">=</span><span class="n">summary_csv</span><span class="p">,</span>
                                  <span class="n">force_reevaluate</span><span class="o">=</span><span class="n">force_reevaluate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Failed for logic_dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="n">all_summaries</span><span class="p">[</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;formula_spec&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">summarize_exp_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

        <span class="c1"># Make sure save names are unique:</span>
        <span class="k">for</span> <span class="n">bestorworst</span> <span class="ow">in</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Visualizations of the </span><span class="si">{</span><span class="n">bestorworst</span><span class="si">}</span><span class="s2"> examples&quot;</span><span class="p">)</span>
            <span class="n">visualize_most_interesting_samples</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_interesting_samples</span><span class="p">,</span> <span class="n">one_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">best</span><span class="o">=</span><span class="p">(</span><span class="n">bestorworst</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">),</span>
                <span class="n">save_as</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s2">&quot;visualizations&quot;</span><span class="p">,</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">logic_type</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">formula_dir</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bestorworst</span><span class="si">}</span><span class="s2">_samples.png&quot;</span><span class="p">),</span>
                <span class="o">**</span><span class="n">iterator_args</span><span class="p">)</span>

    <span class="c1"># Summary plots</span>
    <span class="n">mask_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mask_type</span> <span class="k">for</span> <span class="n">summaries</span> <span class="ow">in</span> <span class="n">all_summaries</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">mask_type</span> <span class="ow">in</span> <span class="n">summaries</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;formula&#39;</span><span class="p">]))</span>
    <span class="n">part_dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">mask_type</span><span class="p">):</span> <span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_summaries</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                                      <span class="k">if</span> <span class="n">mask_type</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">mask_type</span> <span class="ow">in</span> <span class="n">mask_types</span><span class="p">}</span>
    <span class="n">formula_dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">formula_to_display_name</span><span class="p">(</span><span class="n">formula</span><span class="p">):</span> <span class="n">summaries</span>
                   <span class="k">for</span> <span class="n">formula</span><span class="p">,</span> <span class="n">summaries</span> <span class="ow">in</span> <span class="n">all_summaries</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># Make sure save names are unique:</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_root</span><span class="p">,</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">logic_type</span><span class="si">}</span><span class="s2">-per_image_stats_summary&quot;</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
    <span class="n">plot_summaries</span><span class="p">(</span><span class="n">part_dfs</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">fp</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;parts&quot;</span><span class="p">))</span>
    <span class="n">plot_summaries</span><span class="p">(</span><span class="n">formula_dfs</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">fp</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;formulas&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="to_displayable_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.to_displayable_masks.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.to_displayable_masks">[docs]</a><span class="k">def</span> <span class="nf">to_displayable_masks</span><span class="p">(</span><span class="n">masks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">target_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Turn all mask items of ``masks`` into shape ``[h,w]``, potentially splitting up stacked masks. &quot;&quot;&quot;</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">float</span><span class="p">))}</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="n">target_size</span> <span class="ow">or</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                  <span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
    <span class="n">new_masks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># squeeze leading ones in size():  [1, ..., h, w] -&gt; [..., h, w]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># squeeze ones in channel dim: [X, 1, ..., h, w] -&gt; [X, ..., h, w]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># broadcast 1D tensors: [channel,] -&gt; [channel, h, w]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">target_size</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">new_masks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="c1"># split 3D tensors into separate masks: [channel, h, w] -&gt; ([h, w], [h, w], ...)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># just one channel</span>
                <span class="n">new_masks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_masks</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">])})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Encountered mask of size </span><span class="si">{}</span><span class="s2">. Cannot split of broadcast this to mask(s) of size [height, width].&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">new_masks</span></div>


<div class="viewcode-block" id="to_custom_displayable_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.to_custom_displayable_masks.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.to_custom_displayable_masks">[docs]</a><span class="k">def</span> <span class="nf">to_custom_displayable_masks</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
                                <span class="n">person_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;pedestrian&#39;</span><span class="p">,</span>
                                <span class="n">skip_if_max_lower_than</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">mark_if_score_higher_than</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">scores_to_add_to_key</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">reduce_masks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">compare_masks</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">mask_union</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Custom post-process of a formula calculation output dict for easy display with ``compare_orig_with_masks``.</span>
<span class="sd">    Modifications applied:</span>

<span class="sd">    - stacked masks are unstacked or reduced via mask union</span>
<span class="sd">    - the person mask(s) potentially get scores added to their keys according to ``scores_to_add_to_key``</span>
<span class="sd">    - the person mask(s) potentially get marked with color if condition ``mark_if_score_higher_than`` is met</span>
<span class="sd">    - in case conditions are not met (``skip_if_max_lower_than``), ``None`` is returned</span>

<span class="sd">    Assumptions:</span>

<span class="sd">    - tensor of ``len(shape)==1`` is a list of scores (one per prediction)</span>
<span class="sd">    - tensor of ``len(shape)==2`` is a standard masks</span>
<span class="sd">    - tensor of ``len(shape)==3`` are standard masks stacked in dim 0</span>

<span class="sd">    :param out: the dict output of a formula evaluation; only tensors values therein are used</span>
<span class="sd">    :param person_key: the key of the (stacked) person mask(s)</span>
<span class="sd">    :param skip_if_max_lower_than: dict of the form ``{tensor_key: minimum_value_of_max}``;</span>
<span class="sd">        return ``None`` if the max value of tensors in ``out`` at keys are lower</span>
<span class="sd">        than the ``minimum_value_of_max``</span>
<span class="sd">    :param scores_to_add_to_key: add values of given scores to the string key(s) of the (unstacked) person mask(s)</span>
<span class="sd">    :param reduce_masks: reduce the masks at given keys if they are stacked;</span>
<span class="sd">        defaults to all stacked masks except for the person mask(s)</span>
<span class="sd">    :param compare_masks: each item is a list of keys; for each item add a comparison image</span>
<span class="sd">        to the output comparing the masks at keys in that item;</span>
<span class="sd">        if the key of a later unstacked mask is given, the unstacked masks are merged</span>
<span class="sd">        via union for comparison</span>
<span class="sd">    :return: dict of ``{title: mask}`` of 2D and 3D tensors representing masks and images for plotting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_union</span> <span class="o">=</span> <span class="n">mask_union</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">3</span><span class="p">))</span>
    <span class="c1"># Discard non-tensors</span>
    <span class="n">masks_t</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)}</span>
    <span class="n">person_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">masks_t</span><span class="p">[</span><span class="n">person_key</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">person_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">num_preds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">person_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">person_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="c1"># Reduce masks as requested</span>
    <span class="n">reduce_masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reduce_masks</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">masks_t</span><span class="p">]</span> <span class="k">if</span> <span class="n">reduce_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
        <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks_t</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">person_key</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_masks</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">masks_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">masks_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_union</span><span class="p">([</span><span class="n">mask</span><span class="p">])</span>

    <span class="c1"># Skip uninteresting images: No person prediction or no false positive prediction?</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">min_max_val</span> <span class="ow">in</span> <span class="n">skip_if_max_lower_than</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">masks_t</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">masks_t</span> <span class="ow">and</span> <span class="n">masks_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_max_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Extract prediction scores (single values per prediction)</span>
    <span class="n">per_pred_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">masks_t</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">masks_t</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_preds</span><span class="p">}</span>

    <span class="c1"># Explode stacked, unreduced masks</span>
    <span class="n">masks_t</span> <span class="o">=</span> <span class="n">to_displayable_masks</span><span class="p">(</span><span class="n">masks_t</span><span class="p">)</span>

    <span class="c1"># Some custom derived infos</span>
    <span class="n">add_scores</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="n">scores_to_add_to_key</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">per_pred_scores</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_preds</span><span class="p">):</span>
        <span class="c1"># Again filter uninteresting masks:</span>
        <span class="n">curr_person_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">person_key</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">num_preds</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">person_key</span>
        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">masks_t</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">curr_person_key</span><span class="p">)</span>
        <span class="n">min_max_val</span> <span class="o">=</span> <span class="n">skip_if_max_lower_than</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">person_key</span><span class="p">,</span> <span class="n">skip_if_max_lower_than</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr_person_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">min_max_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_mask</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_max_val</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># add scores to key</span>
        <span class="n">score_strings</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">per_pred_scores</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">add_scores</span><span class="p">]</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;ped&quot;</span><span class="o">+</span><span class="p">(</span><span class="n">curr_person_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_preds</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_scores</span><span class="p">):</span>
            <span class="n">new_key</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">score_strings</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># potentially mark mask</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">lower_limit</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mark_if_score_higher_than</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">per_pred_scores</span> <span class="ow">and</span> <span class="n">per_pred_scores</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">lower_limit</span><span class="p">:</span>
                <span class="c1">#new_key = &#39;!&#39;+new_key</span>
                <span class="n">new_mask</span> <span class="o">=</span> <span class="n">to_tens</span><span class="p">(</span><span class="n">data_visualization</span><span class="o">.</span><span class="n">compare_masks</span><span class="p">(</span><span class="n">new_mask</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;yellow&#39;</span><span class="p">,)))</span>
        <span class="n">masks_t</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_mask</span>

    <span class="c1"># Add mask comparisons</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mask_keys</span> <span class="ow">in</span> <span class="n">compare_masks</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="n">curr_masks_t</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">masks_t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">reduce_masks</span><span class="p">,</span> <span class="n">person_key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mask_keys</span><span class="p">:</span>
                <span class="n">curr_masks_t</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">mask_union</span><span class="p">([</span><span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]])})</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_masks_t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mask_keys</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_keys</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39; vs.</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask_keys</span><span class="p">)])</span>
        <span class="n">masks_t</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">to_tens</span><span class="p">(</span><span class="n">data_visualization</span><span class="o">.</span><span class="n">compare_masks</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">curr_masks_t</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mask_keys</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">)),</span>
                   <span class="o">**</span><span class="n">masks_t</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">masks_t</span></div>


<div class="viewcode-block" id="compare_orig_wt_masks"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.compare_orig_wt_masks.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.compare_orig_wt_masks">[docs]</a><span class="k">def</span> <span class="nf">compare_orig_wt_masks</span><span class="p">(</span><span class="n">img_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">masks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">masks_trafo</span><span class="p">:</span> <span class="n">trafos</span><span class="o">.</span><span class="n">Transform</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fig_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">show_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Plot a figure comparing the original ``img_t`` with the created masks (values in [0,1]).</span>
<span class="sd">    If the list of axes to plot the masks into is given, it must have the length of ``masks``</span>
<span class="sd">    (plus one for the original image if ``img_t`` is not ``None``).</span>

<span class="sd">    :param masks_trafo: transformation to be applied to ``masks`` before plotting</span>
<span class="sd">    :param label: y-label of the row</span>
<span class="sd">    :param axes: list of (column) axes into which to plot the images and masks</span>
<span class="sd">    :param save_as: see :py:func:`~hybrid_learning.experimentation.exp_eval_common.show_and_save_plot`</span>
<span class="sd">    :param show_fig: see :py:func:`~hybrid_learning.experimentation.exp_eval_common.show_and_save_plot`</span>
<span class="sd">    :return: the plotted figure (the one of ``axes`` if these are given)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_subplot</span> <span class="o">=</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_subplot</span><span class="p">:</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">img_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
            <span class="n">fig_scale</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">fig_scale</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
    <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="c1"># original</span>
    <span class="k">if</span> <span class="n">img_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">to_img</span><span class="p">(</span><span class="n">img_t</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;orig&quot;</span><span class="p">)</span>
    <span class="c1"># masks</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">tens</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">img_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">i</span>
        <span class="n">tens</span> <span class="o">=</span> <span class="n">masks_trafo</span><span class="p">(</span><span class="n">tens</span><span class="p">)</span> <span class="k">if</span> <span class="n">masks_trafo</span> <span class="k">else</span> <span class="n">tens</span>
        <span class="n">is_grayscale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tens</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tens</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tens</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">to_img</span><span class="p">(</span><span class="n">tens</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span> <span class="k">if</span> <span class="n">is_grayscale</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min/max for&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tens</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">tens</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min/max for&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)),</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;PuBu_r&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="c1"># colorbar</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cbar</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_subplot</span><span class="p">:</span>
        <span class="n">show_and_save_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span> <span class="n">show_fig</span><span class="o">=</span><span class="n">show_fig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="visualize_most_interesting_samples"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.visualize_most_interesting_samples.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.visualize_most_interesting_samples">[docs]</a><span class="k">def</span> <span class="nf">visualize_most_interesting_samples</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                                       <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">best</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                       <span class="n">one_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fig_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                       <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">iterator_args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Plot the masks for most ``num_samples`` interesting samples side by side.</span>
<span class="sd">    &quot;Interesting&quot; here refers to those with the lowest ``mean_interesting`` value</span>
<span class="sd">    (mean of formula mask pixel values for pixels in which one of the input part masks exceeds a value).</span>

<span class="sd">    :param best: whether to plot the best (True) or the worst samples with respect to ``mean_interesting``</span>
<span class="sd">    :param one_figure: whether to plot all into one figure or into single ones</span>
<span class="sd">    :param iterator_args: arguments to :py:class:`~hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator`</span>
<span class="sd">    :param verbose: whether to print information about the plotted samples in a DataFrame</span>
<span class="sd">    :return: the sub-DataFrame with information about plotted samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Values for the most interesting examples (worst `mean_interesting` values for formula):</span>
    <span class="k">if</span> <span class="n">best</span><span class="p">:</span>
        <span class="n">quant_thresh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_interesting&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">num_samples</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="n">sample_infos</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>
                                 <span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_interesting&#39;</span><span class="p">)]</span> <span class="o">&gt;=</span> <span class="n">quant_thresh</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quant_thresh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_interesting&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span>
            <span class="n">num_samples</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="n">sample_infos</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>
                                 <span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_interesting&#39;</span><span class="p">)]</span> <span class="o">&lt;=</span> <span class="n">quant_thresh</span><span class="p">]</span>
    <span class="n">sample_infos</span> <span class="o">=</span> <span class="n">sample_infos</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_infos</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{x}</span><span class="s1"> </span><span class="si">{bestorworst}</span><span class="s1"> of </span><span class="si">{num_all}</span><span class="s1"> samples (</span><span class="si">{num_samples}</span><span class="s1"> </span><span class="si">{bestorworst}</span><span class="s1"> ones with (formula, mean_interesting) </span><span class="si">{gtorlt}</span><span class="s1"> </span><span class="si">{quant_thresh}</span><span class="s1">)&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_infos</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">num_all</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">quant_thresh</span><span class="o">=</span><span class="n">quant_thresh</span><span class="p">,</span>
                        <span class="n">bestorworst</span><span class="o">=</span><span class="s1">&#39;best&#39;</span> <span class="k">if</span> <span class="n">best</span> <span class="k">else</span> <span class="s1">&#39;worst&#39;</span><span class="p">,</span> <span class="n">gtorlt</span><span class="o">=</span><span class="s1">&#39;&gt;=&#39;</span> <span class="k">if</span> <span class="n">best</span> <span class="k">else</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">),</span>
                <span class="n">sample_infos</span><span class="p">)</span>
    <span class="n">masks_trafo</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">])</span>
    <span class="n">loaded_imgs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]]</span> <span class="o">=</span> \
        <span class="nb">list</span><span class="p">(</span><span class="n">ResultsIterator</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">iterator_args</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span> <span class="n">only_filenames</span><span class="o">=</span><span class="n">sample_infos</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)}))</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_infos</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">one_figure</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_imgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_infos</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
            <span class="n">fig_scale</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">fig_scale</span> <span class="o">*</span> <span class="n">num_rows</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">img_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">masks</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loaded_imgs</span><span class="p">):</span>
        <span class="n">compare_orig_wt_masks</span><span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">masks_trafo</span><span class="o">=</span><span class="n">masks_trafo</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{:.3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">img_fn</span><span class="p">,</span> <span class="n">sample_infos</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">img_fn</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_interesting&#39;</span><span class="p">)]),</span>
                              <span class="n">axes</span><span class="o">=</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">one_figure</span><span class="p">:</span>
            <span class="n">show_and_save_plot</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">one_figure</span><span class="p">:</span>
        <span class="n">show_and_save_plot</span><span class="p">(</span><span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                           <span class="n">default_fn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;best&#39;</span> <span class="k">if</span> <span class="n">best</span> <span class="k">else</span> <span class="s1">&#39;worst&#39;</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2">_samples_for_</span><span class="si">{</span><span class="n">conf_to_fn</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sample_infos</span></div>


<div class="viewcode-block" id="plot_summaries"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.plot_summaries.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.plot_summaries">[docs]</a><span class="k">def</span> <span class="nf">plot_summaries</span><span class="p">(</span><span class="n">mask_dfs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                   <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Plot row of bar plots one for each summary mask DataFrame.</span>
<span class="sd">    The summary DataFrames should have the format as provided by</span>
<span class="sd">    :py:func:`hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.summarize_exp_stats`.</span>

<span class="sd">    :param mask_dfs: dictionary of the form ``{mask_type: mask_stats_dataframe}``</span>
<span class="sd">    :param save_as: if not ``None``, save figure under this file path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;plot_summaries encountered empty list of mask data frames! Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_dfs</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">mask_dfs</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mask_type</span><span class="p">,</span> <span class="n">mask_df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">curr_select_key</span> <span class="o">=</span> <span class="n">mask_type</span> <span class="k">if</span> <span class="n">mask_type</span> <span class="ow">in</span> <span class="n">mask_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;formula&quot;</span>
        <span class="n">plot_df</span> <span class="o">=</span> <span class="n">mask_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">curr_select_key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">)),</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">)),</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">))],</span>
                            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">plot_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">rot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                                             <span class="n">title</span><span class="o">=</span><span class="n">mask_type</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">show_and_save_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="plot_metric"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.plot_metric.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.plot_metric">[docs]</a><span class="k">def</span> <span class="nf">plot_metric</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span>
                <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">formulas</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">logic_types</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;lukasiewicz&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;goedel&#39;</span><span class="p">),</span>
                <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{model_key}</span><span class="s2"> </span><span class="si">{metric}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">formula_name_col</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;formula_attrs&#39;</span><span class="p">:</span> <span class="s1">&#39;formula&#39;</span><span class="p">},</span>
                <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">xlim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">to_pretty_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Plot a bar chart for each of the given metrics from entries in metrics_pd.</span>

<span class="sd">    :param metrics_pd: DataFrame with all of ``formula_name_col``, ``&quot;model_key&quot;``, ``metrics``, ``logic_type`` as columns</span>
<span class="sd">    :param verbose: whether to display some intermediate results</span>
<span class="sd">    :param formulas: specifier strings of the formulas to match (simple filter option on ``formula_name_col`` column)</span>
<span class="sd">    :param logic_types: specifier strings of the logic types to match (simple filter option on ``&quot;logic_type&quot;`` column)</span>
<span class="sd">    :param title: figure title; may contain formatting placeholders ``{model_key}`` and ``{metric}``</span>
<span class="sd">    :param formula_name_col: name of the column containing the formula specs to match with ``formulas``</span>
<span class="sd">    :param save_as: if given, either directory or file path where to save this plot</span>
<span class="sd">    :param xlim: if set, the minimum and maximum values displayed on the x-axis;</span>
<span class="sd">        if ``None`` or ``False``, automatically determined by matplotlib</span>
<span class="sd">    :param to_pretty_names: dictionary mapping values of ``model_key`` and ``metrics`` to pretty names</span>
<span class="sd">    :param ax: an axis into which to plot; by default, a new figure is created</span>
<span class="sd">    :return: list with the filtered DataFrames that got plotted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot plot several metrics into one axis! Metrics: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
    <span class="n">to_pretty_names</span> <span class="o">=</span> <span class="n">to_pretty_names</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">to_pretty_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="c1"># Nice ylabel</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formula_name_col</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">formula_name_col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">formula_name_col</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">formula_name_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">formula_name_col</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">formula_name_col</span>

    <span class="c1"># Title</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">lazy_format</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">model_key</span><span class="o">=</span><span class="n">pretty</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pretty</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]))</span>

    <span class="c1"># Show formulas</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="s2">&quot;Available formulas:&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="p">[[</span>
                <span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;formula_attrs&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
        <span class="n">display</span><span class="p">(</span><span class="s2">&quot;Available gt_formulas:&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="p">[[</span>
                <span class="s1">&#39;gt_formula&#39;</span><span class="p">,</span> <span class="s1">&#39;gt_formula_attrs&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>

    <span class="c1"># Pre-process DataFrame: Subsetting &amp; sorting</span>
    <span class="n">formulas</span> <span class="o">=</span> <span class="n">formulas</span> <span class="ow">or</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">([</span><span class="n">formula</span> <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]]))</span>
    <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">formulas</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">metrics_pd</span><span class="o">.</span><span class="n">model_key</span> <span class="o">==</span> <span class="n">model_key</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">logic_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">logic_types</span><span class="p">)]</span> \
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;logic_type&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="p">[</span><span class="n">logic_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">formula_name_col</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="p">[</span><span class="n">formulas</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span>

    <span class="c1"># Display DataFrame</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">option_context</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="n">display</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">[[</span><span class="s1">&#39;formula_attrs&#39;</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;gt_formula&#39;</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">metrics</span><span class="p">,</span> <span class="s1">&#39;logic_dir&#39;</span><span class="p">]]</span>
                    <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">formula_name_col</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="p">[[</span><span class="o">*</span><span class="n">formulas</span><span class="p">,</span> <span class="o">*</span><span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">formula_name_col</span>
                                                                                    <span class="k">else</span> <span class="n">logic_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span> \
                    <span class="c1"># .apply(lambda x: x.map(lambda d: os.path.basename(os.path.dirname(d))) if x.name == &#39;logic_dir&#39; else x) \</span>
                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">highlight_between</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="mi">4</span><span class="o">*</span><span class="mf">0.125</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())),</span>
                                 <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plotted_pds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
        <span class="c1"># Plot DataFrame</span>
        <span class="n">plotted_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[[</span><span class="n">formula_name_col</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">]]</span> \
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">formula_name_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;logic_type&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> \
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="n">formulas</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span> \
            <span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="n">logic_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">row</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plotted_pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Found NaN values for metric </span><span class="si">{}</span><span class="s2">! Please inspect the data more closely:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">plotted_pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">plotted_pd</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plotted_pds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plotted_pd</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plotted_pd</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pretty</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
            <span class="c1">#ax.legend(loc=&#39;center left&#39;, bbox_to_anchor=(1, 0.5))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No data found to plot for model </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">model_key</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># handles, labels = [sum(hl, start=[]) for hl in zip(*[ax.get_legend_handles_labels() for ax in axes])]</span>
        <span class="c1"># fig.legend(handles, labels, loc=&#39;center left&#39;, bbox_to_anchor=(1, 0.5))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fig</span><span class="p">:</span>
        <span class="n">show_and_save_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                           <span class="n">default_fn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">--</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotted_pds</span></div>


<div class="viewcode-block" id="plot_curve"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.plot_curve.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.plot_curve">[docs]</a><span class="k">def</span> <span class="nf">plot_curve</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
               <span class="c1"># Axes</span>
               <span class="n">x</span><span class="o">=</span><span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="c1"># Varying factors and constraints</span>
               <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;maskrcnn_box&#39;</span><span class="p">,</span>
               <span class="n">logic_types</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;lukasiewicz&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;goedel&#39;</span><span class="p">),</span>
               <span class="n">formulas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="c1"># Additional plot infos</span>
               <span class="n">add_diagonal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">add_value_hints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">add_markers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">legend_outer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="c1"># Style options</span>
               <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ROC </span><span class="si">{model_key}</span><span class="s2"> (</span><span class="si">{variable}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
               <span class="n">formula_name_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;formula_attrs&#39;</span><span class="p">,</span>
               <span class="n">to_pretty_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">lims</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                   <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
               <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a curve of ``y`` against ``x`` varying the value of ``variables[0]`` given ``constraints``.</span>
<span class="sd">    For each entry in ``logic_types`` and ``formulas``, and for each value of entries in ``variables[1:]``,</span>
<span class="sd">    produce a new line.</span>

<span class="sd">    To just get a normal plot, call</span>
<span class="sd">    ``plot_curve(x=&#39;x&#39;, y=&#39;y&#39;, variables=[&#39;x&#39;], add_value_hints=False, add_diagonal=False, ...)``.</span>

<span class="sd">    :param x: column name of the x-values</span>
<span class="sd">    :param y: column name of the y-values</span>
<span class="sd">    :param variables: keys of variables in the DataFrame to vary over;</span>
<span class="sd">        different values for the first one are plotted into one curve,</span>
<span class="sd">        further variables will create new curves for different values</span>
<span class="sd">    :param constraints: mapping of keys of variables in the dataframe to a fixed value; used to filter the DataFrame</span>
<span class="sd">    :param model_key: shorthand for ``constraints={&#39;model_key&#39;: model_key}``</span>
<span class="sd">    :param logic_types: filter the DataFrame for any of these values of the ``&quot;logic_type&quot;`` column</span>
<span class="sd">    :param formulas: if given, filter the DataFrame for any of these values of the ``formula_name_col`` column</span>
<span class="sd">    :param formula_name_col: see formulas</span>
<span class="sd">    :param add_value_hints: whether to add small text fields with the values of ``variable`` at each sample point</span>
<span class="sd">    :param add_diagonal: add a diagonal; set to ``False`` to disable; else set to</span>
<span class="sd">        ``&#39;start_at_one&#39;`` (default for PR-curves) or ``&#39;start_at_zero&#39;`` (default else)</span>
<span class="sd">    :param legend_outer: whether to put the legend of plots outside of the plot</span>
<span class="sd">    :param title: figure or axis title; may contain formatting placeholders ``{model_key}``, and ``{variable}`` (for ``variables[0]``)</span>
<span class="sd">    :param to_pretty_names: dictionary mapping values of ``model_key`` and ``metrics`` to pretty names</span>
<span class="sd">    :param verbose: whether to also prettily display all values of the relevant columns of the DataFrame</span>
<span class="sd">    :param lims: tuple of ``((xmin, xmax), (ymin, ymax))`` to set the xlim and ylim of the axes</span>
<span class="sd">    :param save_as: if given, either directory or file path where to save this plot</span>
<span class="sd">    :return: all plotted rows of the DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Argument defaults</span>
    <span class="n">formulas</span> <span class="o">=</span> <span class="p">[</span><span class="n">formulas</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formulas</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">formulas</span>
    <span class="n">add_diagonal</span> <span class="o">=</span> <span class="n">add_diagonal</span> <span class="k">if</span> <span class="n">add_diagonal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span>
        <span class="s1">&#39;start_at_one&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;recall&#39;</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">==</span> <span class="s1">&#39;precision&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;start_at_zero&#39;</span><span class="p">)</span>
    <span class="n">to_pretty_names</span> <span class="o">=</span> <span class="n">to_pretty_names</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">to_pretty_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>

    <span class="c1"># Value check for constraints</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">),</span> \
        <span class="s2">&quot;Overlap between keys to vary and constrained keys:</span><span class="se">\n</span><span class="s2">variables: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">constraints: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">variables</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col_keys</span><span class="p">,</span> <span class="n">col_desc</span> <span class="ow">in</span> <span class="p">[([</span><span class="n">x</span><span class="p">],</span> <span class="s1">&#39;x-axis&#39;</span><span class="p">),</span> <span class="p">([</span><span class="n">y</span><span class="p">],</span> <span class="s1">&#39;y-axis&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">)]:</span>
        <span class="k">for</span> <span class="n">col_key</span> <span class="ow">in</span> <span class="n">col_keys</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">col_key</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;Missing </span><span class="si">{}</span><span class="s2"> column </span><span class="si">{}</span><span class="s2"> from metrics_pd; available columns: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">col_desc</span><span class="p">,</span> <span class="n">col_key</span><span class="p">,</span> <span class="n">metrics_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Title</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">lazy_format</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">model_key</span><span class="o">=</span><span class="n">pretty</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span> <span class="n">variable</span><span class="o">=</span><span class="n">pretty</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>

    <span class="c1"># Subsetting &amp; types</span>
    <span class="n">metrics_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[(</span><span class="n">metrics_pd</span><span class="o">.</span><span class="n">model_key</span> <span class="o">==</span> <span class="n">model_key</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">metrics_pd</span><span class="o">.</span><span class="n">logic_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">logic_types</span><span class="p">))]</span>
    <span class="c1"># Get formulas that have data for more than one variable value:</span>
    <span class="n">formulas</span> <span class="o">=</span> <span class="n">formulas</span> <span class="ow">or</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">formula</span> <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]</span>
                                       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">[</span><span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">formula</span><span class="p">][</span><span class="n">variable</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]))</span>  <span class="c1"># == set(metrics_pd[variable])]))</span>

    <span class="n">plotted_pd</span> <span class="o">=</span> <span class="n">metrics_pd</span><span class="p">[</span><span class="n">metrics_pd</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">formulas</span><span class="p">)]</span> \
        <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">plotted_pd</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plotted_pd</span>

        <span class="c1"># Display DataFrame</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">option_context</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="n">display</span><span class="p">(</span><span class="n">metrics_pd</span><span class="p">[[</span><span class="s1">&#39;formula_attrs&#39;</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;gt_formula&#39;</span><span class="p">,</span> <span class="s1">&#39;logic_type&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">variables</span><span class="p">,</span> <span class="s1">&#39;logic_dir&#39;</span><span class="p">]]</span> \
                    <span class="c1"># .sort_values([&#39;formula&#39;, &#39;logic_type&#39;], key = lambda col: [formulas.index(e) if col.name==&#39;formula&#39; and e in formulas else logic_types.index(e) for e in col]) \</span>
                    <span class="c1"># .apply(lambda x: x.map(lambda d: os.path.basename(os.path.dirname(d))) if x.name == &#39;logic_dir&#39; else x) \</span>
                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">variables</span><span class="p">)</span> <span class="k">else</span> <span class="n">col</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">highlight_between</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="p">)</span>

    <span class="n">line_specs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">plotted_pd</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">formula_name_col</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;logic_type&#39;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">variable</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Colors</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>
    <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
               <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">add_markers</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">line_specs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_specs</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Got </span><span class="si">%d</span><span class="s2"> combinations of (logic_type, formula) but only have </span><span class="si">%d</span><span class="s2"> colors, so some lines will get the same color!&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_specs</span><span class="p">),</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_specs</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Got </span><span class="si">%d</span><span class="s2"> combinations of (logic_type, formula) but only have </span><span class="si">%d</span><span class="s2"> marker types, so some lines will get the same marker!&quot;</span><span class="p">,</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">line_specs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">,</span> <span class="n">variable_vals</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">line_specs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lf</span><span class="p">:</span> <span class="p">(</span><span class="n">lf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logic_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lf</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lf</span><span class="p">[</span><span class="mi">2</span><span class="p">]))):</span>
        <span class="n">variable_vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">variable_vals</span><span class="p">)</span>
        <span class="n">curr_plotted_pd</span> <span class="o">=</span> <span class="n">constrain_pd</span><span class="p">(</span><span class="n">plotted_pd</span><span class="p">,</span> <span class="p">{</span><span class="n">formula_name_col</span><span class="p">:</span> <span class="n">formula</span><span class="p">,</span>
                                                    <span class="s1">&#39;logic_type&#39;</span><span class="p">:</span> <span class="n">logic_type</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">variable_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">constraints</span><span class="p">})</span>
        <span class="c1"># Plot the data</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">curr_plotted_pd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                                  <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pretty</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">logic_type</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pretty</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="o">**</span><span class="n">variable_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">constraints</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">formula</span><span class="p">]</span>
                                                   <span class="k">if</span> <span class="n">pretty</span><span class="p">(</span><span class="n">s</span><span class="p">)]),</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)])</span>
        <span class="c1"># Add diagonal</span>
        <span class="n">diag_points</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">add_diagonal</span> <span class="k">else</span> <span class="p">(</span>
            <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">add_diagonal</span> <span class="o">==</span> <span class="s1">&#39;start_at_one&#39;</span> <span class="k">else</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">diag_points</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">diag_points</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Set format and meta-data</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)),</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="n">pretty</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend_outer</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="c1"># Add value hints</span>
        <span class="k">if</span> <span class="n">add_value_hints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">curr_plotted_pd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">y</span><span class="p">]),</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                            <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                            <span class="c1">#arrowprops = {&#39;width&#39;: .5, &#39;headwidth&#39;: .5, &#39;headlength&#39;: .5, &#39;shrink&#39;:0.05}</span>
                            <span class="p">)</span>
    <span class="n">show_and_save_plot</span><span class="p">(</span>
        <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span> <span class="n">default_fn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">--</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">_vs_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_over_</span><span class="si">{</span><span class="n">variable</span><span class="si">}{</span><span class="s1">&#39;_with_&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotted_pd</span></div>


<div class="viewcode-block" id="visualize_random_samples"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.visualize_random_samples.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.visualize_random_samples">[docs]</a><span class="k">def</span> <span class="nf">visualize_random_samples</span><span class="p">(</span>
        <span class="n">experiment_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logic_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">formula_dirs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">changed_constants</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># dict(mask_thresh=0.1),</span>
        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">only_filenames</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_missing</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span>
        <span class="n">save_as</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">additional_formula_mods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span>
            <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">,</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">],</span> <span class="n">fuzzy_logic</span><span class="o">.</span><span class="n">Merge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># dict(</span>
        <span class="c1">#recalced=(lambda formula_obj, _: formula_obj),</span>
    <span class="c1">#recalced_gt=(lambda _, gt_formula_obj: gt_formula_obj),</span>
    <span class="c1">#non_binary=(lambda formula_obj, _: formula_obj.in_keys[0]),</span>
    <span class="c1">#threshed_concepts=(lambda formula_obj, _: formula_obj.in_keys[0].in_keys[1]),</span>
    <span class="c1">#unthreshed_concepts=(lambda formula_obj, _: formula_obj.in_keys[0].in_keys[1].in_keys[1]),</span>
    <span class="c1">#any_concept_formula = (lambda formula_obj, _: formula_obj.in_keys[0].in_keys[0]),</span>
    <span class="c1"># )</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;For the first ``num_samples`` samples visualize the cached concept and recalculated formula output masks.</span>
<span class="sd">    The formula objects given by ``additional_formula_mods`` are recalculated based on the given</span>
<span class="sd">    ``changed_constants``, and displayed together with the concept outputs.</span>
<span class="sd">    The original formula objects and settings are loaded from the sacred experiment logs,</span>
<span class="sd">    the concept outputs are loaded from cache (defined in experiment settings).</span>
<span class="sd">    For the experiment logs, the following folder structure is assumed:</span>
<span class="sd">    ``experiment_root/model_key/split/&lt;formula_dir&gt;/&lt;logic_type&gt;/logs/``</span>

<span class="sd">    :param additional_formula_mods: see :py:class:`~hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator`</span>
<span class="sd">    :param changed_constants: see :py:class:`~hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.ResultsIterator`</span>
<span class="sd">    :param num_samples: number of samples to plot</span>
<span class="sd">    :param skip_missing: see :py:func:`~hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_eval.to_logic_dirs`</span>
<span class="sd">    :param save_as: see :py:func:`~hybrid_learning.experimentation.exp_eval_common.show_and_save_plot`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">only_filenames</span><span class="p">)</span> <span class="k">if</span> <span class="n">only_filenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">num_samples</span>
    <span class="n">additional_formula_mods</span> <span class="o">=</span> <span class="n">additional_formula_mods</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">logic_dirs</span> <span class="o">=</span> <span class="n">to_logic_dirs</span><span class="p">(</span><span class="n">experiment_root</span><span class="o">=</span><span class="n">experiment_root</span><span class="p">,</span> <span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                               <span class="n">formula_dirs</span><span class="o">=</span><span class="n">formula_dirs</span><span class="p">,</span> <span class="n">logic_type</span><span class="o">=</span><span class="n">logic_type</span><span class="p">,</span> <span class="n">skip_missing</span><span class="o">=</span><span class="n">skip_missing</span><span class="p">)</span>
    <span class="c1"># Collect infos &amp; plot visualizations</span>
    <span class="k">for</span> <span class="n">logic_dir</span> <span class="ow">in</span> <span class="n">logic_dirs</span><span class="p">:</span>
        <span class="c1"># GET FORMULA AND ITERATOR</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">get_exp_conf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logic_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">),</span> <span class="n">conf_validation_vals</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">model_key</span><span class="o">=</span><span class="n">model_key</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">))</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">ResultsIterator</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="o">=</span><span class="ow">not</span> <span class="n">skip_missing</span><span class="p">,</span> <span class="n">only_filenames</span><span class="o">=</span><span class="n">only_filenames</span><span class="p">,</span>
                                   <span class="n">additional_formula_mods</span><span class="o">=</span><span class="n">additional_formula_mods</span><span class="p">,</span>
                                   <span class="n">changed_constants</span><span class="o">=</span><span class="n">changed_constants</span><span class="p">,</span>
                                   <span class="n">recalc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">masks_trafo</span> <span class="o">=</span> <span class="n">trafos</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;img_size&#39;</span><span class="p">])</span>

        <span class="c1"># PLOT AND COLLECT HISTOGRAM (on the first X available samples)</span>
        <span class="n">all_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_img_fns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">found_something_to_plot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">img_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">masks_t</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">num_samples</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="o">*</span><span class="n">masks_t</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
                <span class="n">num_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">skipped_img_fns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_fn</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">found_something_to_plot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">masks_t</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
                    <span class="mi">3</span><span class="o">*</span><span class="n">num_cols</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">num_rows</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">compare_orig_wt_masks</span><span class="p">(</span><span class="n">img_t</span><span class="p">,</span> <span class="n">masks_t</span><span class="p">,</span> <span class="n">masks_trafo</span><span class="o">=</span><span class="n">masks_trafo</span><span class="p">,</span>
                                  <span class="n">label</span><span class="o">=</span><span class="n">img_fn</span><span class="p">,</span>
                                  <span class="n">axes</span><span class="o">=</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">found_something_to_plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_img_fns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_missing</span> <span class="o">==</span> <span class="s1">&#39;warn&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Skipped descriptors due to missing files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">skipped_img_fns</span><span class="p">)</span>
            <span class="n">show_and_save_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                               <span class="n">default_fn</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;random_samples_with_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">changed_constants</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="si">}</span><span class="s2">_for_</span><span class="si">{</span><span class="n">conf_to_fn</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Did not find any descriptor to plot due to missing files.&quot;</span><span class="p">)</span>

        <span class="c1"># HISTOGRAM</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_vals</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                 <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>  <span class="c1"># of interest for low threshold</span></div>


<div class="viewcode-block" id="conf_to_fn"><a class="viewcode-back" href="../../../../apiref/generated/hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.conf_to_fn.html#hybrid_learning.experimentation.fuzzy_exp.fuzzy_exp_vis.conf_to_fn">[docs]</a><span class="k">def</span> <span class="nf">conf_to_fn</span><span class="p">(</span><span class="n">conf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Turn a sacred experiment config to a unique file name.&quot;&quot;&quot;</span>
    <span class="n">formula_dir</span> <span class="o">=</span> <span class="n">calc_helpers</span><span class="o">.</span><span class="n">formula_spec_to_dir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;formula_spec&quot;</span><span class="p">],</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;fuzzy_logic_key&quot;</span><span class="p">],</span>
                                      <span class="n">constants</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;constants&quot;</span><span class="p">],</span> <span class="n">predicate_setts</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;predicate_setts&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">formula_dir</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;fuzzy_logic_key&quot;</span><span class="p">]])</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Continental Automotive GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>